<!DOCTYPE html>
<html lang="en">
<head>
	<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0,minimal-ui" />
	<meta charset="UTF-8">
	<title>退款商品</title>
	<link rel="stylesheet" href="__PUBLIC__/Home/css/resetstyle.css">
	<link rel="stylesheet" href="__PUBLIC__/Home/fonts/iconfont.css">
	<link rel="stylesheet" href="https://at.alicdn.com/t/font_527495_p8cbsn51ch2utyb9.css">
	<script src="__PUBLIC__/Home/js/jquery-1.10.1.js"></script>
	<script src="__PUBLIC__/Admin/js/plugins/layer/layer.min.js"></script>
	<script src="__PUBLIC__/Home/js/public.js"></script>
	<style>
		body{
			font-size: 0.7rem;
			width: 100vw;
			overflow: hidden;
		}
		.appContain>h3,.appsureContain>h3{
			padding:0.666667rem 5% 0;
			font-size: 0.72rem;
		    font-weight: 500;
		    color: #5a5a5a;
		}
		/*一个item的样式*/
		.itemContain>.item{
			height: 5.7rem;
			border-bottom:10px solid #F3F3F3;
			padding:0.666667rem 5%;
		}
		.item>.appLeft{
			float: left;
			width: 45%;
			height: 100%;
			line-height: 8rem;
		}
		.item>.appLeft>span{
			float: left;
			width: 90%;
		}
		.item>.appLeft>span>img{
			width: 100%;
			line-height: 8rem;
		}
		/*item右边*/
		.item>.appRight{
			width: 50%;
			height: 100%;
			float: right;
		}
		.appRight>h4{
			line-height: 1.0rem;
			font-size: 0.72rem;
			font-weight: 700;
			color: #5a5a5a;
		}
		.appRight>.changTxt{
			/*height:57%;*/
			font-size: 0.213333rem;
			overflow:hidden;
			color: #5A5A5A; 
			font-size: 0.68rem;
			text-overflow:ellipsis;
			display:-webkit-box; 
			-webkit-box-orient:vertical;
			box-orient:vertical;
			-webkit-line-clamp:4; 
			line-clamp:4; 
		}
		.appRight>p{
			display: block;
			width: 100%;
			line-height: 1.8rem;
			font-size: 0.68rem;
		}
		.appRight>p>b{
			color: #FC2A2B;

		}
		.appRight>p>span{
			float: right;
			color: #5a5a5a;
			font-size: 0.72rem;

		}
		/*商品状态块applist样式*/
		.applist{
			border-bottom:10px solid #F3F3F3;

		}
		.applist>p{
			padding:0 5%;
			display: block;
			height: 2.2rem;
			line-height: 2.2rem;
			border-bottom:1px solid #F3F3F3;
			color:#373737;
			font-size: 0.68rem;
		}
		.applist>p>span{
			float: right;
		    display: block;
		    width: 60%;
		    color: #5a5a5a;
			font-size: 0.68rem;
		}
		.applist>p>span.yuanzhifu{
			width: 27%;
		}
		
		.applist>p>span>i{
			margin-left: 0.4rem;
			font-size: 0.6rem;
		}
		.applist>p>span>select{
			background: #FFF;
			width: 90%;
 			border:none;
 			color: #5a5a5a;
			font-size: 0.68rem;
		}
		.applist>p.shuoming{
			border:none;

		}
		.applist>p.shuoming>i{
			font-weight: normal;
			color: #F00;
		}
		.applist>p.tuikuang{
			/*margin-top: 3rem;*/
			border-top:1px solid #F3F3F3;
		}
		.applist>label{
			display: block;
			color: #5a5a5a;
		    font-size: 0.68rem;
		}
		.applist>label>p{
			padding:0 5%;
			display: block;
			height: 1.6rem;
			line-height: 2rem;
			color:#373737;
		}
		.applist>label>p>i{
			color: #F00;
		}
		.applist>label>textarea{
			font-size: 0.453333rem;
			height:5rem;
			width:90%;
			line-height: 0.8rem;
			resize: none;
			border: none;
			padding:0 5%;
		    color: #5a5a5a;
		    font-size: 0.68rem;
		}

		.applist>p.tuikuang>em{
			color: #FC2A2B;
			font-weight: 700;
			margin-left: 0.2rem;
		}
		.applist>p.tuikuang>span{
			font-size:0.186667rem;
			color: #5a5a5a;
			font-size: 0.60rem;
		}
		/*图片上传*/
		.sendpic{
			width: 100%;
			height: 8rem;
			padding:0 5%;
			margin-bottom: 5rem;
			box-sizing: border-box;
		}
		.sendpic>p{
			line-height: 2rem;
			color:#373737;
		}
		.picBtn{
			position: relative;
		}
		.picBtn>i{
			font-size: 4rem;
			color:#DCF8FF;
		}
		.picBtn>span{
			position: absolute;
		    bottom: 0.7rem;
		    left: 1.2rem;
			color: #5a5a5a;
			font-size: 0.42rem;
		}
		.picBtn>input{
			opacity: 0;
			display: block;
		    width: 4.3rem;
		    height: 4.2rem;
		    position: absolute;
		    top: 0.58rem;
		    left: 0.3rem;
		}
						
		/*底部按钮*/
		.appFoot{
			height: 1.8rem;
			width: 100%;
			position: fixed;
    		bottom: 0;
			text-align: center;
			line-height: 1.8rem;
			z-index:12;
		}
		.appFoot>input{
			width: 100%;
			height: 100%;
			border:none;
			display: inline-block;
			background: #2EB6AA;
			color: #FFF;
			font-size: 0.82rem;
			letter-spacing: 0.1rem;
		}

		/*确认申请退款*/
		.appsureContain{
			position: fixed;
			left:0;
			top:0;
			background: #C7C7C7;
			height: 100%;
			width: 100%;
			opacity: 0.5;
			z-index: 94;
			display: none;
			
		}
		.appsureFoot{
			position: fixed;
			bottom: 0;
			height: 12rem;
			width: 100%;
			z-index: 999; 
			background: #FFF;
			display: none;

		}
		.appsureFoot>h3{
			display: block;
			height: 2rem;
			width: 100%;
			text-align: center;
			line-height: 2rem;
			margin-bottom: 2rem;

		}
		.appsureFoot>p{
			width: 95;
			padding: 0 5%;
			display: block;
			height: 2rem;
			line-height: 2rem;
		}
		.appsureFoot>p>b{
			display: inline-block;
		    width: 22%;
		    margin-right: 0.4rem;
		}
		.appsureFoot>p>span{
			font-size: 0.186667rem;
		    color: #797979;
		}
		.appsureFoot>p>i{
			float: right;
			color: #56AAF1;
			font-size: 0.8rem;
		}
		.appsureFoot>input{
			width: 100%;
		    border: none;
		    background: #2EB6AA;
		    color: #FFF;
		    height: 2rem;
		    margin-top: 2rem;
		}

        /*显示上传的图片*/
        #picShow { 
        	position: absolute;
        	width: 66%;
        	height: 4rem;
        	bottom: 0;
        	right: 0;
        	display: block;
        }
        #picShow>span {
        	width: 30%;
        	height: 100%;
        	display: inline-block;
        	position: relative;
        	margin: 0 4px;
        }
        #picShow>span>img {
        	width: 100%;
        	height: auto;
        	position: absolute;
        	top: 50%;
        	transform: translateY(-50%);
        }
        .delPic {
        	position: absolute;
        	width: .8rem;
        	height: .8rem;
        	top: -10px;
        	right: 0;
        	display: flex;
        	justify-content: center;
        	align-items: center;
        	color: #fff;
        	border-radius: 50%;
        	background: red;
        }
		
			
	</style>
</head>
<body>
	<form class="appContainall" id="form">
		<div class="appContain">
			<h3>退款商品</h3>
			<div class="itemContain clearfix">
				<!-- <div class="item clearfix">
					<div class="appLeft">
						<span><img src="__PUBLIC__/Home/images/ro_01_03.png" alt=""></span>
					</div>
					<div class="appRight">
						<h4>RO膜</h4>
						 <div class="changTxt">
							RO膜能够有效地去除水中钙、 镁、细菌、有机物、无机物、金 属离子和放射性物质属离子性物质属离子离子性物质属离子
						</div>
						<p><b>￥120.00</b><span>X1</span></p> 
					</div>
				</div> -->
				<!-- <div class="item clearfix">
					<div class="appLeft">
						<span><img src="__PUBLIC__/Home/images/ro_01_03.png" alt=""></span>
					</div>
					<div class="appRight">
						<h4>RO膜</h4>
						 <div class="changTxt">
							RO膜能够有效地去除水中钙、 镁、细菌、有机物、无机物、金 属离子和放射性物质属离子性物质属离子离子性物质属离子
						</div>
						<p><b>￥120.00</b><span>X1</span></p> 
					</div>
				</div>
				<div class="item clearfix">
					<div class="appLeft">
						<span><img src="__PUBLIC__/Home/images/ro_01_03.png" alt=""></span>
					</div>
					<div class="appRight">
						<h4>RO膜</h4>
						 <div class="changTxt">
							RO膜能够有效地去除水中钙、 镁、细菌、有机物、无机物、金 属离子和放射性物质属离子性物质属离子离子性物质属离子
						</div>
						<p><b>￥120.00</b><span>X1</span></p> 
					</div>
				</div>
				<div class="item clearfix">
					<div class="appLeft">
						<span><img src="__PUBLIC__/Home/images/ro_01_03.png" alt=""></span>
					</div>
					<div class="appRight">
						<h4>RO膜</h4>
						 <div class="changTxt">
							RO膜能够有效地去除水中钙、 镁、细菌、有机物、无机物、金 属离子和放射性物质属离子性物质属离子离子性物质属离子
						</div>
						<p><b>￥120.00</b><span>X1</span></p> 
					</div>
				</div> -->

			</div>
			<!-- list -->
			<div class="applist">
				<p class="clearfix"><b>商品状态</b><span>
					<select class="method">
					   <option value ="volvo">请选择</option>
					   <option value ="volvo">仅退款(未发货)</option>
					   <option value ="saab">退货退款(已收到货)</option>
					</select>   				
				<!-- <i class="iconfont icon-dayuhao-copy-copy"></i> -->
				</span></p>
				<p class="clearfix"><b>退款原因</b><span>
					<select class="reason">
					   <option value ="volvo">请选择</option>
					   <option value ="volvo">质量问题退货</option>
					   <option value ="saab">选拍错了</option>
					   <option value ="saab">其他原因</option>
					</select>   
				</span></p>
				<label for="Laddr">
	              <p><b>退款说明：</b><i>*</i></p>
	              <textarea name="" id="Laddr" cols="30" rows="10" placeholder=""></textarea>
	            </label>
				<p class="tuikuang clearfix "><b>退款金额：</b><em class="money">￥120.00</em><span class="yuanzhifu">回原支付方式</span></p>
			</div>
			<!-- /*图片上传*/ -->
			<div class="sendpic">
				<p><b>上传凭证</b></p>
				<div class="picBtn">
					<i class="iconfont icon-tianjia"></i>
					<span>限3张内</span>
					<input class="file_upload" type="file" accept="image/gif,image/jpeg,image/jpg,image/png,image/svg">
					<div id="picShow"></div>
				</div>
			</div>	
		</div>

		<div class="appFoot">
			<input type="button" value="提交">
		</div>
		
	</form>
  	<script src="__PUBLIC__/Home/js/upFile.js"></script>
	<script>
		var goodsInfo = JSON.parse(sessionStorage.getItem("goodsInfo"));
		console.log(goodsInfo);
		// 商品 id 集合
		var gidArr = [];
		for(var i=0; i<goodsInfo.length; i++){
			gidArr.push(goodsInfo[i].gid);
		}
		// console.log(gidArr);
		/*
			遍历数据
		 */
		var html = '';
		var money = 0;
		$.each(goodsInfo, function(index, value){
			// console.log(index, value)
			// 遍历数据
			html += '<div class="item clearfix">'+
					'<div class="appLeft">'+
						'<span><img src="'+ value.path +'" alt=""></span>'+
					'</div>'+
					'<div class="appRight">'+
						'<h4>'+ value.title +'</h4>'+
						 '<div class="changTxt">'+ value.brief +'</div>'+
						'<p><b>￥'+ value.price +'</b><span>X'+ value.num +'</span></p> '+
					'</div>'+
				'</div>';
				// 统计金额
				money += Number(value.price)*Number(value.num);
		})
		// console.log(money)
		$(".money").text('￥' + money);
		// 添加到页面
		$(".itemContain").html(html);
		/*
			点击 ’商品状态-选择‘
		 */
		$(".sendpic").hide();	// 默认不需要图片凭证
		var method_index;	//商品状态选择的 第几个状态
		// var formData = new formData();

		$('.method').on('change', function(){
			method_index = $(this)[0].selectedIndex;
			console.log(method_index)
			// 仅退款（未发货）
			if(method_index == 1){	// 不需要图片凭证
				$(".sendpic").hide();

			}else if(method_index == 2 || method_index == 3){	// 需要图片凭证
				$(".sendpic").show();

			}
		})
		/*
			点击提交
		 */
		 $(".appFoot").click(function(){
		 		/*
			 		method: 商品状态，
			 		reason: 退款原因，
			 		description: 退款说明，
			 		gid: 商品 id
		 	 	*/ 
		 	var method = $(".method>option:selected");
		 	var reason = $(".reason>option:selected");
		 	var description = $("#Laddr").val();
		 	var gid = gidArr;
		 	// console.log(gid)
		 	//	清空， 防止多次点击
		 	formData.delete('gid[]');
		 	formData.delete('order_id');
		 	formData.delete('method');
		 	formData.delete('reason');
		 	formData.delete('description');
		 	formData.delete('num');
		 	formData.delete('price');
		 	formData.delete('total_amount');
 
		 	//重新赋值
		 	for(var i=0; i<gid.length; i++){

		 		formData.append('gid[]', gid[i]);
		 	}
		 	formData.append('order_id', goodsInfo[0].order_id);
		 	formData.append('method', method[0].index);
		 	formData.append('reason', reason[0].index);
		 	formData.append('description', description);
		 	formData.append('num', goodsInfo[0].num);
		 	formData.append('price', goodsInfo[0].price);
		 	formData.append('total_amount', money);

		 	if(method[0].index != 0 && reason[0].index != 0 && description){
		 		console.log('通过!');

			 	console.log('order_id: ',formData.getAll('order_id'));
			 	console.log('gid[]: ',formData.getAll('gid[]'));
			 	console.log('num: ',formData.getAll('num'));
			 	console.log('price: ',formData.getAll('price'));
			 	console.log('method: ',formData.getAll('method'));
			 	console.log('reason: ',formData.getAll('reason'));
			 	console.log('description: ',formData.getAll('description'));
			 	console.log('total_amount: ',formData.getAll('total_amount'));
			 	console.log('UploadForm[]: ', formData.getAll('UploadForm[]'));
		 		/*
		 			提交给后台
		 	 	*/
		 	 	$.ajax({
		 	 		url: '{{:U("Home/Refund/create")}}',
		 	 		type: 'post',
		 	 		data: formData,
		 	 		cache: false,
		 	 		processData: false,
		 	 		contentType: false,
		 	 		success: function(res){
		 	 			console.log('请求成功！', res);
		 	 			if(res.code == 200){	//提交成功
		 	 				parent.layer.msg('提交成功！');
		 	 				// location.href = '{{:U("")}}';
		 	 			}
		 	 		},
		 	 		error: function(res){
		 	 			console.log('请求失败！', res)
		 	 		}
		 	 	})
			}else if(method[0].index == 0){	//未选择

				parent.layer.msg('请选择商品状态！');
			 	console.log('请选择商品状态！');
			 	return false;

			}else if(reason[0].index == 0){	//未选择
				parent.layer.msg('请选择退款原因！');
			 	console.log('请选择退款原因！');
			 	return false;

			}else if(!description){
				parent.layer.msg('请填写退款说明！');
			 	console.log('请填写退款说明！');
			 	return false;

			}
		 	
		 })
	</script>
</body>
</html>