<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0,minimal-ui" />
	<meta http-equiv="X-UA-Compatible" content="ie=edge" />
  	<link rel="stylesheet" href="__PUBLIC__/Home/css/resetstyle.css">
 	<link rel="stylesheet" href="__PUBLIC__/Home/fonts/iconfont.css">
	<script src="__PUBLIC__/Home/js/jquery-1.10.1.js"></script>
  	<script src="__PUBLIC__/Home/js/public.js"></script>
	<title>商品详情</title>
</head>
<style>
	body, h1, h2, h3, h4, h5, h6, hr, p, blockquote, dl, dt, dd, ul, ol, li, pre, form, fieldset, legend, button, input, textarea, th, td,span { margin:0; padding:0; box-sizing: border-box;}

	body{
		font-size: 0.7rem;
		color: #373737;
	}
	.shopdetailContain{
		padding-bottom: 2rem;
	}
	/*商品图片*/
	.detailTop{
		border-bottom:20px solid #f3f3f3;
		padding-bottom: 4rem;
	}
	.detailpic{
		box-sizing: border-box;
	    width: 100%;
	    padding: 1.5rem 4.5rem;
	    text-align: center;
	}
	.detailpic>img{
		width: 100%;
	}
	/*商品说明*/
	.detailTxt{
		width: 100%;
	}
	.detailTxt>span{
		padding: 0 0.5rem;
		display: inline-block;
	    width: 100%;
	    height: 1.6rem;
	    line-height: 1.6rem;
	    background: #F04B7E;
	     color: #FFF;
		

	}
	.detailTxt>span>b{
		float: left;
		font-size: 1.0rem;
		font-weight: 500;
	}
	.detailTxt>span>em{
		display: inline-block;
		height: 1.6rem;
	    line-height: 1.6rem;
		padding:0rem 0.3rem;
		float: right;
	}
	.detailTxt>p{
		padding: 0.2rem 5%;
		font-size: 0.72rem;
	}
	.detailTxt>em{
		display: block;
		padding: 0.2rem 5%;
		font-size: 0.62rem;
		color: #F04B7E;
	}
	/*商品数量，邮费*/
	.detailist{
		padding: 0.5rem 5% 0;
	}
	.detailist>p{
		padding:0.7rem 0;
		border-bottom:1px solid #E5E5E5;
		color: #5a5a5a;
	}
	
	.detailist>p>span{
		font-size: 0.72rem;
		color: #373737;
	}
	.detailist>p>span>b{
		font-weight: 400;
	}
	.detailist>p>span:last-child{
		float: right;
	}
	.detailist>p>span>input:first-child{
		font-size: 0.6rem;
		font-weight: 600;
	}
	.detailist>p>span:last-child>em{
		border:0.013333rem solid #000;
		font-size: 0.4rem;
		padding: 0.05rem 0.1rem;
		margin:0 0.1rem;
	}
	/*评论内容*/
	.detailContain{
		padding: 2rem 0;
	}
	/*个人评论标题*/
	.detailtitle{
		position: relative;
		text-align: center;
		font-size: 0.72rem;
	}
	.detailtitle>p{
		color:#bfbfbf;
		line-height: 3rem;
	}
	.detailtitle>p>b{
		padding:0 0.5rem;
		font-weight: 400;
		color: #373737;
	}

    /*商品数量*/
    .num {
        width: 30%;
        display: -webkit-box;
        display: -ms-flexbox;
        display: flex;
        -webkit-box-pack: center;
            -ms-flex-pack: center;
                justify-content: center;
        -webkit-box-align: stretch;
            -ms-flex-align: stretch;
                align-items: stretch;
    }

    .num>input {
        width: 1.2rem;
        height: 1.4rem;
        line-height: 1.4rem;
        display: -webkit-box;
        display: -ms-flexbox;
        -webkit-box-pack: center;
            -ms-flex-pack: center;
        -webkit-box-align: center;
            -ms-flex-align: center;
                align-items: center;
        text-align: center;
        font-size: 0.9rem;
        border: none;
        -webkit-appearance: none;
        border-radius: 4px;
        background: #e2e2e2;
    }
    .num>input:nth-of-type(2){
    	background: #fff;
    }
    .num>input:nth-of-type(3){
    	padding-bottom: 0.06rem;
    }
    .num>.number {
        width: 33%;
        margin: 0 4px;
        text-align: center;
        border-radius: 4px;
        border: 1px solid #a4a4a4;
        font-size: .8rem;
    }
	.detailContain>p{
		padding: 2.5rem 5% 0.4rem;
		font-size: 0.68rem;
		position: relative;

	}
	.detailContain>p>i{
		font-size: 1.1rem;
		padding-right: 0.05rem;
		color:#FBC91D;
		position: relative;
		top: 0.05rem;
		margin-right: 0.3rem;
	}
	.detailItem>p>span{
		font-size: 0.68rem;
	}
	/*个人评论内容*/
	.detailItem{
		padding:0.6rem 5%;
		border-bottom:10px solid #f3f3f3;
	}
	.detailItem>p{
		padding: 0.2rem 5% 0.2rem 0;
	    font-size: 0.68rem;
	    line-height: 1.0rem;
	    margin:0.5rem;

	}
	.detailItem>p>em{
		display: inline-block;
		height: 2rem;
		width: 2rem;
		border-radius: 1.5rem;
		border:1px solid #ccc;
		margin-right: 0.3rem;
		float: left;
	}
	.detailItem>p>em>img{
		width: 100%;
	}
	.detailItem>p>b{
		display: inline-block;
	    height: 2rem;
	    line-height: 2rem;
	}
	.detailItem>span{
		margin-right: 0.8rem;
		display: inline-block;
		width: 20%;
		height: 3rem;
		border:1px solid #f3f3f3;
		border-radius: 0.2rem;
		overflow: hidden;
	}
	.detailItem>span>img{
		width: 100%;
		padding: 0.2rem 0.15rem;
		border-radius: 0.2rem;
	}
	/*查看更多*/
	.detailContain>.pinglunshow{
		position: relative;
	    top: 0rem;
	    right: 0;
	    padding: 0.8rem 0 5%;
	    color: #F04B7E;
	}

	.pinglunshow>p{
		display: block;
	    height: 2rem;
	    width: 25%;
	    font-size: 0.7rem;
	    float: right;
	}
	.pinglunshow>p>span{
		padding-left: 5%;
	}
	/*底部*/
	.shopdetailBott{
		width: 100%;
		position: fixed;
		display: flex;
		bottom: 0 ;
		margin-top:0.68rem;
		background: #FFF;
		overflow: hidden;
		border-top:1px solid #E5E5E5;
		font-size: 0.74rem;
	}
	.shopdetailBott>div{
		display: inline-block;
		width: 80%;
		box-sizing: border-box;
	}
	.shopdetailBott>a {
		width: 20%;
		height: 8vh;
		display: inline-block;
		line-height: 8vh;
		text-align: center;
	}
	.shopdetailBott>a:active>i{
		color: #960532;
	}
	.shopdetailBott>a>i{
		font-size: 1.2rem;

    	color: #F04B7E;
	}
	.shopdetailBott>div>input{
		padding: 0.64rem;
		background: #F04B7E;
		border:none;
		width: 52%;
		color:#fff;
		border-radius: 0px!important;
	}
	.icon-gouwuche {
		position: relative;
	}
	.icon-gouwuche>span {
		position: absolute;
		display: flex;
		justify-content: center;
		align-items: center;
		width: 70%;
		height: 70%;
		top: -20%;
		right: -40%;
		color: #fff;
		border-radius: 50%;
		font-size: 16px;
		background: #f00;
	}
	/*加入购物车*/
	#add2ShopCart {
		height: 8vh;
		width: 46%;
	    display: inline-block;
	    line-height: 8vh;
	    text-align: center;
	}
	#add2ShopCart:active {
		color: #fff;
		background: #F04B7E;
	}

</style>
<body>
	<div class="shopdetailContain">
		<div class="detailTop">
			<!-- /*商品信息*/ -->
			<div>
				<!-- <div class="detailpic">
					<img src="__PUBLIC__/Home/images/comm_02.png" alt="">
				</div> -->
				<!-- /*商品说明*/ -->
				<!-- <div class="detailTxt">
					<span><b>￥5699.00</b><em>已售： 210</em></span>
					<p>尼康（Nikon）D3300 单反套机（AF-P DX 18- 55 mm/3.5-5.6G VR 防抖镜头</p>
					<em>送包、滤镜、存储卡、读卡器、清洁套装</em>
				</div> -->
			</div>
			<!-- /*商品数量，邮费*/ -->
		</div>
		<div class="detailContain">
			<!-- 个人评论标题 -->
			<div class="detailtitle"><p>——<b>商品口碑</b>——</p></div>
			<p><i class="iconfont icon-jingdiananli_wujiaoxing_shoucanghou"></i><span>总评：4.9</span></p>
			<!-- 	/*个人评论内容*/ -->
			<div class="detailItemall">
				<!-- <div class="detailItem">
					<p><em><img src="__PUBLIC__/Home/images/comm_02.png" alt=""></em><b>CICI</b></p>
					<p>宝贝好喜欢好喜欢</p>
					<span><img src="__PUBLIC__/Home/images/comm_02.png" alt=""></span>
					<span><img src="__PUBLIC__/Home/images/comm_02.png" alt=""></span>
					<span><img src="__PUBLIC__/Home/images/comm_02.png" alt=""></span>
				</div>
				<div class="detailItem">
					<p><em><img src="__PUBLIC__/Home/images/comm_02.png" alt=""></em><b>CICI</b></p>
					<p>宝贝好喜欢好喜欢</p>
				</div>  -->
				<!-- 隐藏的评论 -->
			</div>
			<div class="pinglunshow"><p>查看更多<span class="iconfont icon-shuangxiajiantou"></span></p></div>
		</div>
		<div class="shopdetailBott">
			<a href="{{:U('ShoppingCart/index')}}">
				<i class="iconfont icon-gouwuche"><span>{{$cartInfo}}</span></i>
			</a>
			<div>
				<div id="add2ShopCart">加入购物车</div>
				<input id="buyNow" type="button" value="立即购买">
			</div>
		</div>
	</div>
	<script src="__PUBLIC__/Admin/js/plugins/layer/layer.min.js"></script>
	<script>
	$(function(){

		//清除历史发票信息sessionStorage
		sessionStorage.setItem("voiceArr", '');
		//显示购物车数量
		if(typeof Number($("#cartInfo").val()) == 'number'){
			$('.cartnum>span').text($("#cartInfo").val())

		}else{
			$('.cartnum>span').text(0);
		}
		//存放ajax请求成功返回的商品信息
		var goodsDetail;
		// 从本地sessionStorage中获取从商城首页点击的商品唯一id
		var goods_gid = sessionStorage.getItem("goods_gid");
		console.log(goods_gid)
		var desc;
		// ajax发送商品id查询商品详情
		$.ajax({
			url: '{{:U("Shop/goods_detail")}}',
			type: 'get',
			data: {'id': goods_gid},
			success: function(res){
				console.log('成功！ ',res);
				//显示购物车数量
				$(".icon-gouwuche>span").text(res.cartnum);
				goodsDetail = res.goodsDetail[0];
				var goodsDetail_html = '', commentInfo_html = '';
				desc = !goodsDetail.desc ? '商品暂无描述' : goodsDetail.desc;
				goodsDetail.attr = !goodsDetail.attr ? '' : goodsDetail.attr;
				// 输出商品详情
				goodsDetail_html = '<div class="detailpic">'+
						'<img src="/Uploads/'+ goodsDetail.path +'" alt="">'+
					'</div>'+
					'<!-- /*商品说明*/ -->'+
					'<div class="detailTxt">'+
						'<span><b>￥'+ goodsDetail.price +'</b><em>已售： 210</em></span>'+
						'<p></p>'+
						'<em>'+ goodsDetail.attr +'</em>'+
					'</div>'+
					'<!-- /*商品选择，数量，邮费*/ -->'+
					'<div class="detailist">'+
						'<p>'+
							'<span>数量</span>'+
							'<span class="num">'+
								'<input type="button" value="—" class="minus">'+
								'<input class="number" type="number" value="1" min="1" max="19">'+
								'<input type="button" value="+" class="plus">'+
							'</span>'+
						'</p>'+
						'<p><span>邮费</span><span><b class="expressMoney">￥<span>8.88</span></b></span></p>'+
					'</div>'; 
				console.log(res.commentInfo[0])
				// 如果有评价则遍历出来		
				if(res.commentInfo){
					if(res.commentInfo.length > 1){
						for(var i=0; i<res.commentInfo.length; i++){
							res.commentInfo[i].nickname = res.commentInfo[i].nickname == null ? '不知道是谁' : res.commentInfo[i].nickname;
							res.commentInfo[i].content = res.commentInfo[i].content == null ? '该用户暂未评论' : res.commentInfo[i].content;
							res.commentInfo[i].path = res.commentInfo[i].path == null ? '' : res.commentInfo[i].path;
							commentInfo_html += '<div class="detailItem">'+
								'<p><em><img src="'+ res.commentInfo[i].head +'" alt=""></em><b>'+ res.commentInfo[i].nickname +'</b></p>'+
								'<p>'+ res.commentInfo[i].content +'</p>'+
								'<span><img src="'+ res.commentInfo[i].path +'" alt=""></span>'+
							'</div>';
						}
					}else{
						res.commentInfo.nickname = res.commentInfo.nickname == null ? '不知道是谁' : res.commentInfo.nickname;
						res.commentInfo.content = res.commentInfo.content == null ? '该用户暂未评论' : res.commentInfo.content;
						res.commentInfo.path = res.commentInfo.path == null ? '' : res.commentInfo.path;
						commentInfo_html += '<div class="detailItem">'+
							'<p><em><img src="'+ res.commentInfo.head +'" alt=""></em><b>'+ res.commentInfo.nickname +'</b></p>'+
							'<p>'+ res.commentInfo.content +'</p>'+
							'<span><img src="'+ res.commentInfo.path +'" alt=""></span>'+
						'</div>';
					}
				}else{
					commentInfo_html = '暂无评价';
				}

				// 将商品信息添加到页面
				$(".detailTop>div").html(goodsDetail_html);
				// 将评价添加到页面
				$(".detailItemall").append(commentInfo_html);

				// console.dir($('.detailItem').length);
				// 只显示2条评论
				var _length=$('.detailItem').length;
				if (_length>2) {
					$('.detailItem').css('display','none');
					$('.detailItem:nth-child(1)').css('display','block');
					$('.detailItem:nth-child(2)').css('display','block');
				}
				$(".detailTxt p").html(escape2Html(desc));
			},
			error: function(res){
				console.log('失败！ ',res)
			}
		})
		//处理后台传过来的转义字符
		var escape2Html = function(str) {   
			 var arrEntities={'lt':'<','gt':'>','nbsp':' ','amp':'&','quot':'"'};   
			 return str.replace(/&(lt|gt|nbsp|amp|quot);/ig,function(all,i){
			 	return arrEntities[i];
			 });   
		}; 
		var price;
		/*
			 按加'+'号
		 */
		$(".shopdetailContain").on("touchend",'.plus',function(){
			price = 0;	//合计归零，后面重新计算
			// 获取数量
			var value = $(".number").val();
			$(this).siblings(".number")[0].value++;

		});
		/*
			按减'-'号
		 */
		$(".shopdetailContain").on("touchend",".minus",function(){
			price = 0;	//合计归零，后面重新计算
			// 获取数量
			var value = $(".number").val();
			for(var i=0; i<$(this).siblings(".number").length; i++){
				$(this).siblings(".number").val() <= 1
				? 1
				: $(this).siblings(".number")[i].value--
			}
			// console.log($(this).siblings(".number")[0].value);

		});
		// 点击‘更多’展开评论或者收起
		$('.pinglunshow>p').click(function(){
			// console.dir($(this).find("span").attr('class'));
			var _class=$(this).find("span").attr('class');

			if(_class=='iconfont icon-shuangxiajiantou'){
				// $('.detailItem:nth-of-type(1)').css('display','block');
				$('.detailItem').slideDown('slow');

				$(this).find("span").removeClass('iconfont icon-shuangxiajiantou').addClass('iconfont icon-xiangshangjiantou');

			}else{
				$(this).find("span").removeClass('iconfont icon-xiangshangjiantou').addClass('iconfont icon-shuangxiajiantou');

				$('.detailItem').slideUp('fast');

				// $('.detailItem').eq(0).slideDown('slow');
				// $('.detailItem').eq(1).slideDown('slow');
				$('.detailItem').eq(0).css('display','block');
				$('.detailItem').eq(1).css('display','block');
			
			}
		})

		/*
			点击‘加入购物车’
		 */
		$("#add2ShopCart").click(function(){
			var num = $(".number").val();	//选择的数量
			var addtime = new Date().getTime();	//添加进购物车的时间
			/*
				goods_gid:商品唯一ID
				num: 商品数量
			 */
			var data = JSON.stringify([{'gid':goods_gid,'num':num}])
			console.log(data)
			$.ajax({
				url: '{{:U("ShoppingCart/shopAdd")}}',
				type: 'post',
				data: {'gid': goods_gid,'num':num},
				success: function(res){
					console.log('成功！ ', res)
					//更新购物车数量
					$('.icon-gouwuche>span').text(res);
	       			parent.layer.msg('添加成功！');
				},
				error: function(res){
					console.log('失败！ ', res)
	       			parent.layer.msg('添加失败！');
				}
			})
		})	
 
		/*
			点击‘立即购买’
		 */
		$("#buyNow").click(function(){
			//清除其他页面的sessionStorage
			sessionStorage.setItem("lvxinData", '');
			sessionStorage.setItem("shopCar_data", '');
			var num = $(".number").val();	//选择的数量
			var expressMoney = $(".expressMoney>span").text();	//快递费
			/*
				goods_gid:商品唯一ID
				num: 商品数量
				uid: 用户id
			 */
			var goods_data = JSON.stringify({'goodsDetail': goodsDetail,'num': num,'expressMoney':expressMoney});
			sessionStorage.setItem("goods_data",goods_data);
			//发送给后台生成订单编号的数据
			var goods_dataArr = [];
			var money = num*(goodsDetail.price);	//订单总价
			goods_dataArr.push({'num':num,'gid': goodsDetail.gid,'money': money});
			
			sessionStorage.setItem("goods_dataArr",JSON.stringify(goods_dataArr));
			console.dir(goods_dataArr);
			
			// 发送ajax请求让后台生成订单号
			$.ajax({
				url: '{{:U("PaymentSystem/information")}}',
				type: 'post',
				data: {'data': JSON.stringify(goods_dataArr)},
				success: function(res){
					console.log('成功！', res);
					sessionStorage.setItem('order_id',res);
					//解绑事件
					$("#buyNow").off('click');
					if(typeof JSON.parse(res) == 'number'){

						// 跳转到订单确认页面
						location.href = '{{:U("PaymentSystem/payConfirm")}}';
					}else{
						//支付发生错误，无法生成订单号
						parent.layer.msg('系统发生错误，请稍后再试，还望谅解！');
					}
				},
				error: function(res){
					console.log('失败！', res);
				}
			})
		})
	})

	</script>
</body>
</html>
