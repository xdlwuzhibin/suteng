<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0,minimal-ui" />
	<meta http-equiv="X-UA-Compatible" content="ie=edge" />
  	<link rel="stylesheet" href="__PUBLIC__/Home/css/resetstyle.css">
 	<link rel="stylesheet" href="__PUBLIC__/Home/fonts/iconfont.css">
 	<link rel="stylesheet" href="__PUBLIC__/Home/css/shop/detail.css">
	<title>商品详情</title>
</head>
<body>
	<input type="hidden" value='{{$sold_num}}' id="sold_num">
	<!-- <input type="hidden" value='{{$postage}}' id="postage"> -->
	<div class="shopdetailContain">
		<div class="detailTop">
			<!-- /*商品信息*/ -->
			<div>
				<!-- <div class="detailpic">
					<ul id='wrapul'>
						<li><img src="__PUBLIC__/Home/images/comm_02.png" alt=""></li>
					</ul>
				</div> -->
				<!-- /*商品说明*/ -->
				<!-- <div class="detailTxt">
					<span><b>￥5699.00</b><em>已售： 210</em></span>
					<p>尼康（Nikon）D3300 单反套机（AF-P DX 18- 55 mm/3.5-5.6G VR 防抖镜头</p>
					<em>送包、滤镜、存储卡、读卡器、清洁套装</em>
				</div> -->
			</div>
			<!-- /*商品数量，邮费*/ -->
		</div>
		<div class="detailContain">
			<!-- 个人评论标题 -->
			<div class="detailtitle"><p>——<b>商品口碑</b>——</p></div>
			<p><i class="iconfont icon-jingdiananli_wujiaoxing_shoucanghou"></i><span>总评：4.9</span></p>
			<!-- 	/*个人评论内容*/ -->
			<div class="detailItemall">
				<!-- <div class="detailItem">
					<p><em><img src="__PUBLIC__/Home/images/comm_02.png" alt=""></em><b>CICI</b></p>
					<p>宝贝好喜欢好喜欢</p>
					<span><img src="__PUBLIC__/Home/images/comm_02.png" alt=""></span>
					<span><img src="__PUBLIC__/Home/images/comm_02.png" alt=""></span>
					<span><img src="__PUBLIC__/Home/images/comm_02.png" alt=""></span>
				</div>
				<div class="detailItem">
					<p><em><img src="__PUBLIC__/Home/images/comm_02.png" alt=""></em><b>CICI</b></p>
					<p>宝贝好喜欢好喜欢</p>
				</div>  -->
				<!-- 隐藏的评论 -->
			</div>
			<div class="pinglunshow"><p>查看更多<span class="iconfont icon-shuangxiajiantou"></span></p></div>
		</div>
		<div class="shopdetailBott">
			<a href="{{:U('ShoppingCart/index')}}">
				<i class="iconfont icon-gouwuche"><span>{{$cartInfo}}</span></i>
			</a>
			<div>
				<div id="add2ShopCart">加入购物车</div>
				<input id="buyNow" type="button" value="立即购买">
			</div>
		</div>
	</div>
	<script src="__PUBLIC__/Home/js/jquery-1.10.1.js"></script>
  	<script src="__PUBLIC__/Home/js/public.js"></script>
  	<script src="__PUBLIC__/Home/js/shop/tmove.js"></script>
	<script src="__PUBLIC__/Admin/js/plugins/layer/layer.min.js"></script>
	<script>
	$(function(){
		// 首页按钮
		!function(){
			// 创建 a 标签
			var home = document.createElement('a');
			home.innerText = '首\n页';

			home.href = '{{:U("Home/Shop/index")}}';
			home.setAttribute("id", 'back2Home');

			// 添加到页面
			document.body.appendChild(home);
			home.onclick = function(){
				home.style.background = '#aaa';
			}
			return
			// console.log(home)
		}()
		// var postage = $("#postage").val();
		var sold_num = $('#sold_num').val();
		//清除历史发票信息sessionStorage
		sessionStorage.setItem("voiceArr", '');
		//显示购物车数量
		if(typeof Number($("#cartInfo").val()) == 'number'){
			$('.cartnum>span').text($("#cartInfo").val())

		}else{
			$('.cartnum>span').text(0);
		}
		//存放ajax请求成功返回的商品信息
		var goodsDetail;
		// 从地址栏URL中获取从商城首页点击的商品唯一id
		var goods_gid = location.search.substr(location.search.indexOf("=")+1);
		// console.log(goods_gid)
		var desc;
		var picPathArr = []; 	//存放后台传过来的图片路径转换的数组
		var commPicArr = [];	//存储每条评论的图片
		var goodsPicArr = [];	//顶部图片浏览
		// ajax发送商品id查询商品详情
		$.ajax({
			url: '{{:U("Shop/goods_detail")}}',
			type: 'get',
			async: false,
			data: {'id': goods_gid},
			success: function(res){
				console.log('成功！ ',res);
				//显示购物车数量
				$(".icon-gouwuche>span").text(res.cartnum);
				goodsDetail = res.goodsDetail[0];
				var goodsDetail_html = '', commentInfo_html = '';
				desc = !goodsDetail.desc ? '商品暂无描述' : goodsDetail.desc;
				goodsDetail.attr = !goodsDetail.attr ? '' : goodsDetail.attr;
				// 接受邮费数据
				goodsCourier = res.goodsCourier;
				goodsCourier_html = "";// 邮费数据
				for (var i = 0; i < goodsCourier.length; i++) {
					goodsCourier_html = goodsCourier_html + '<option index='+i+'>'+goodsCourier[i].cname+'</option>'
				}
				// 商品图片
				goodsPicArr.push(goodsDetail.path);
				// 输出商品详情
				goodsDetail_html = '<div class="detailpic"><ul id="wrapul"></ul></div>'+
					'<!-- /*商品说明*/ -->'+
					'<div class="detailTxt">'+
						'<span><b>￥'+ goodsDetail.price +'</b><em>已售： '+ sold_num +'</em></span>'+
						'<b>'+ goodsDetail.name +'</b>'+
						'<p></p>'+
						'<em>'+ goodsDetail.attr +'</em>'+
					'</div>'+
					'<!-- /*商品选择，数量，邮费*/ -->'+
					'<div class="detailist">'+
						'<p>'+
							'<span>数量</span>'+
							'<span class="num">'+
								'<input type="button" value="—" class="minus">'+
								'<input class="number" type="number" value="1" min="1" max="19">'+
								'<input type="button" value="+" class="plus">'+
							'</span>'+
						'</p>'+
						// 邮费

						'<div class="selectPostage">'+

							// 显示点击
							'<span><select  class="postage" required><option>快递</option>'+

							goodsCourier_html


							+'</select></span><span class="postagename">邮费</span>'
						'</div>'+
					'</div>';
				console.log(res.commentInfo.length)
				// 如果有评价则遍历出来
				if(res.commentInfo){
					if(res.commentInfo.length > 1){
						for(var i=0; i<res.commentInfo.length; i++){
							commPicArr[i] = []; //初始化
							res.commentInfo[i].nickname = res.commentInfo[i].nickname == null ? '不知道是谁' : res.commentInfo[i].nickname;
							res.commentInfo[i].content = res.commentInfo[i].content == null ? '该用户暂未评论' : res.commentInfo[i].content;
							res.commentInfo[i].path = res.commentInfo[i].path == null ? '' : res.commentInfo[i].path;
							commentInfo_html += '<div class="detailItem">'+
								'<p><em><img src="'+ res.commentInfo[i].head +'" alt=""></em><b>'+ res.commentInfo[i].nickname +'</b></p>'+
								'<p>'+ res.commentInfo[i].content +'</p>'+
							'</div>';
							picPathArr = res.commentInfo[i].path.split('|');
							// 存储每条评论的图片
							for(var j=0; j<picPathArr.length; j++){

								commPicArr[i].push({'img':'<span><img class="commPic" src="/Uploads/'+ picPathArr[i] +'" alt=""></span>'});
							}
						}
					}else{
						res.commentInfo.nickname = res.commentInfo.nickname == null ? '不知道是谁' : res.commentInfo.nickname;
						res.commentInfo.content = res.commentInfo.content == null ? '该用户暂未评论' : res.commentInfo.content;
						res.commentInfo.path = res.commentInfo.path == null ? '' : res.commentInfo.path;
						commentInfo_html += '<div class="detailItem">'+
							'<p><em><img src="'+ res.commentInfo.head +'" alt=""></em><b>'+ res.commentInfo.nickname +'</b></p>'+
							'<p>'+ res.commentInfo.content +'</p>'+
							'<span><img src="'+ res.commentInfo.path +'" alt=""></span>'+
						'</div>';
					}
				}else{
					commentInfo_html = '暂无评价';
				}

				// 将商品信息添加到页面
				$(".detailTop>div").html(goodsDetail_html);

				/* 顶部图片滑动部分 -- 开始 */
				var goodsPicHTML = '';
				goodsPicArr.map(function(value,index){
					goodsPicHTML += '<li><img src="/Uploads/'+ value +'" alt=""></li>';
				})
				// console.log(goodsPicHTML);
				$('.detailpic>ul').html(goodsPicHTML);
				// console.log($('.detailpic>ul>li'));
				// 设置图片宽度
				$('.detailpic>ul')[0].style.width = goodsPicArr.length*100 + '%';
				$('.detailpic>ul').find('li').css({width: 100/goodsPicArr.length + '%'});
				var wrapul = document.getElementById('wrapul');
				var lilen = wrapul.getElementsByTagName('li').length;
				// 实例化滑动
				var move = new tMove(wrapul, lilen);
				/* 顶部图片滑动部分 -- 结束 */

				// 将评价添加到页面
				$(".detailItemall").append(commentInfo_html);
				// console.log(picPathArr, '\n', commPicArr);
				// 遍历评论列表的每个评论的图片
				for(var m=0; m<commPicArr.length; m++){
					for(var n=0; n<commPicArr[m].length; n++){
						// console.log('468: ', commPicArr[m][n].img)
						$(".detailItem").eq(m).append(commPicArr[m][n].img)
					}
				}
				// console.dir($('.detailItem').length);
				// 只显示2条评论
				var _length=$('.detailItem').length;
				if (_length>2) {
					$('.detailItem').css('display','none');
					$('.detailItem:nth-child(1)').css('display','block');
					$('.detailItem:nth-child(2)').css('display','block');
				}
				// $(".detailTxt p").html(escape2Html(desc));
			},
			error: function(res){
				console.log('失败！ ',res)
			}
		})
		
		// 点击选择邮费
		$(".postage").on("change", function() {
			// 邮费种类
			postageName = $(this).val();
			// 邮费某条数
			postageNum = $(this).find("option:selected").attr("index");
			// 根据条数找到对应的价格
			postageMoney = goodsCourier[postageNum].cprice;
			$(".postagename").text(postageMoney)
		})

		//处理后台传过来的转义字符
		var escape2Html = function(str) {
			 var arrEntities={'lt':'<','gt':'>','nbsp':' ','amp':'&','quot':'"'};
			 return str.replace(/&(lt|gt|nbsp|amp|quot);/ig,function(all,i){
			 	return arrEntities[i];
			 });
		};
		var price;
		/*
			 按加'+'号
		 */
		$(".shopdetailContain").on("touchend",'.plus',function(){
			price = 0;	//合计归零，后面重新计算
			// 获取数量
			var value = $(".number").val();
			$(this).siblings(".number")[0].value++;

		});
		/*
			按减'-'号
		 */
		$(".shopdetailContain").on("touchend",".minus",function(){
			price = 0;	//合计归零，后面重新计算
			// 获取数量
			var value = $(".number").val();
			for(var i=0; i<$(this).siblings(".number").length; i++){
				$(this).siblings(".number").val() <= 1
				? 1
				: $(this).siblings(".number")[i].value--
			}
			// console.log($(this).siblings(".number")[0].value);

		});
		// 点击‘更多’展开评论或者收起
		$('.pinglunshow>p').click(function(){
			// console.dir($(this).find("span").attr('class'));
			var _class=$(this).find("span").attr('class');

			if(_class=='iconfont icon-shuangxiajiantou'){
				// $('.detailItem:nth-of-type(1)').css('display','block');
				$('.detailItem').slideDown('slow');

				$(this).find("span").removeClass('iconfont icon-shuangxiajiantou').addClass('iconfont icon-xiangshangjiantou');

			}else{
				$(this).find("span").removeClass('iconfont icon-xiangshangjiantou').addClass('iconfont icon-shuangxiajiantou');

				$('.detailItem').slideUp('fast');

				// $('.detailItem').eq(0).slideDown('slow');
				// $('.detailItem').eq(1).slideDown('slow');
				$('.detailItem').eq(0).css('display','block');
				$('.detailItem').eq(1).css('display','block');

			}
		})

		/*
			点击‘加入购物车’
		 */
		$("#add2ShopCart").click(function(){
			if($(".postage").find("option:selected").val() == "快递") {
				parent.layer.msg('请选择快递方式');
				return false;
			}

			var num = $(".number").val();	//选择的数量
			var addtime = new Date().getTime();	//添加进购物车的时间
			// var expressMoney = $(".postagename").text();	//快递费
			var expressMoney = goodsCourier[postageNum];	//快递费goodsCourier[postageNum]
			/*
				goods_gid:商品唯一ID
				num: 商品数量
			 */
			var data = JSON.stringify([{'gid':goods_gid,'num':num, 'expressMoney':expressMoney}])
			console.log(data)
			$.ajax({
				url: '{{:U("ShoppingCart/shopAdd")}}',
				type: 'post',
				data: {'gid': goods_gid,'num':num, 'expressMoney':expressMoney},
				success: function(res){
					console.log('成功！ ', res)
					//更新购物车数量
					$('.icon-gouwuche>span').text(res);
					sessionStorage.setItem('cartnum', res);
	       			parent.layer.msg('添加成功！');
				},
				error: function(res){
					console.log('失败！ ', res)
	       			parent.layer.msg('添加失败！');
				}
			})
		})

		/*
			点击‘立即购买’
		 */
			$("#buyNow").click(function(){

			if($(".postage").find("option:selected").val() == "快递") {
				parent.layer.msg('请选择快递方式');
				return false;
			}

			//清除其他页面的sessionStorage
			sessionStorage.setItem("lvxinData", '');
			sessionStorage.setItem("shopCar_data", '');
			var num = $(".number").val();	//选择的数量
			var expressMoney = $(".postagename").text();	//快递费
			var postageInfo = goodsCourier[postageNum];
			/*
				goods_gid:商品唯一ID
				num: 商品数量
				uid: 用户id
			 */
			var goods_data = JSON.stringify({'goodsDetail': goodsDetail,'num': num,'expressMoney':expressMoney});
			sessionStorage.setItem("goods_data",goods_data);
			//发送给后台生成订单编号的数据
			var goods_dataArr = [];
			var money = num*(goodsDetail.price);	//订单总价
			goods_dataArr.push({'num':num,'gid': goodsDetail.gid,'money': money, 'postage': postageInfo});

			sessionStorage.setItem("goods_dataArr",JSON.stringify(goods_dataArr));
			// console.dir(goods_dataArr);return false;

			// 发送ajax请求让后台生成订单号
			$.ajax({
				url: '{{:U("PaymentSystem/information")}}',
				type: 'post',
				data: {'data': JSON.stringify(goods_dataArr)},
				success: function(res){
					console.log('成功！', res);
					sessionStorage.setItem('order_id',res);
					//解绑事件
					$("#buyNow").off('click');
					if(typeof JSON.parse(res) == 'number'){

						// 跳转到订单确认页面
						location.href = '{{:U("Pay/payConfirm")}}';
					}else{
						//支付发生错误，无法生成订单号
						parent.layer.msg('系统发生错误，请稍后再试！');
					}
				},
				error: function(res){
					console.log('失败！', res);
				}
			})
		})






	})

	</script>
</body>
</html>
