<!DOCTYPE html>
<html lang="zh">
<head>
	<meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0,minimal-ui" />
	<meta http-equiv="X-UA-Compatible" content="ie=edge" />
  	<link rel="stylesheet" href="__PUBLIC__/Home/css/resetstyle.css">
 	<link rel="stylesheet" href="__PUBLIC__/Home/fonts/iconfont.css">
 	<!-- <link rel="stylesheet" href="https://at.alicdn.com/t/font_527495_v25vpfqtkjegsyvi.css"> -->
  	<link rel="stylesheet" type="text/css" href="__PUBLIC__/Home/css/font-awesome.css">
    <link rel="stylesheet" href="__PUBLIC__/Home/css/style.css">
    <link rel="stylesheet" href="__PUBLIC__/Home/css/shop/index.css">
	<title>商城首页</title>
</head>
<body>
	<input type="hidden" value='{{$cate}}' id="_cate">
	<input type='hidden' value='{{$goods}}' id='_goods'>
	<input type="hidden" value='{{$cartInfo}}' id="cartInfo">
	<header id="header">
		<!-- <span class="tab" index='0'>净水器</span>
		<span class="tab" index='1'>净化器</span>
		<span class="tab" index='2'>热水器</span>
		<span class="tab" index='3'>生活用品</span>
		<span class="tab" index='4'>瓦胆</span>
		<div id="line"></div> -->
	</header>
	<div class="shopTop clearfix">
		<div class="search clearfix">
			<label for="search-all">
				<input type="text" placeholder="请输入您想买的东西" ><i class="searchBtn iconfont icon-msnui-find-bold"></i>
			</label><i class="iconfont  icon-gouwuche"></i><span class="cartnum"><span></span></span>
			<div id="searchPanel">
				<!-- <p>见识到了官方十多个</p>
				<p>见识到了官方十多个</p>
				<p>见识到了官方十多个</p> -->
			</div>
		</div>

		<!-- 轮播图 -->
		<div id="wrapper">
	
			<div id="slider-wrap">
			  <ul id="slider">
			    <li><a class="pic" goods_gid="{{$goodsList[0]['gid']}}" href="javascript:;"><img src="/Uploads/{{$goodsList[0]['path']}}" /></a></li>
			    <li><a class="pic" goods_gid="{{$goodsList[1]['gid']}}" href="javascript:;"><img src="/Uploads/{{$goodsList[1]['path']}}" /></a></li>
			    <li><a class="pic" goods_gid="{{$goodsList[2]['gid']}}" href="javascript:;"><img src="/Uploads/{{$goodsList[2]['path']}}" /></a></li>
			    <li><a class="pic" goods_gid="{{$goodsList[3]['gid']}}" href="javascript:;"><img src="/Uploads/{{$goodsList[3]['path']}}" /></a></li>
			    <li><a class="pic" goods_gid="{{$goodsList[4]['gid']}}" href="javascript:;"><img src="/Uploads/{{$goodsList[4]['path']}}" /></a></li>		 
			  </ul>
			  
			   <!--controls-->
			  <div class="btns" id="next"><i class="fa fa-arrow-right"></i></div>
			  <div class="btns" id="previous"><i class="fa fa-arrow-left"></i></div>
			  <div id="counter"></div>
			  
			  <div id="pagination-wrap">
				<ul>
				</ul>
			  </div>
			  <!--controls-->  
					 
			</div>
		</div>		
	</div>
	<div id="content">
		
		<!-- 净水器 -->
		<!-- <div id="waterPurifier">
			 <div class="goods" > -->
				<!-- /*所有商品*/ -->
				<!-- <div class="goodstitle">
					<h3><span>——</span> 特惠专区 <span>——</span></h3>
				</div>
				<div class="allgoods">
					<ul>
						<li>
							<a href="#">
								<img src="__PUBLIC__/Home/images/goods1.png" alt="">
								<p>Jagabee 麦片套装</p>
								<b>¥ 89.00</b><i class="iconfont icon-jiarugouwuche "></i><span class="iconfont "></span>
							</a>
						</li>
					</ul>
				</div>
			</div>
		</div> -->
	</div>
	
	<script src="__PUBLIC__/Home/js/jquery-1.10.1.js"></script>
  	<script src="__PUBLIC__/Home/js/public.js"></script>
	<script src="__PUBLIC__/Admin/js/plugins/layer/layer.min.js"></script>
	<script>
		$(function(){

			//首页显示购物车数量
			// console.log($("#cartInfo").val())
			if(JSON.parse($("#cartInfo").val())){
				$(".cartnum>span").text(JSON.parse($("#cartInfo").val()));
			}else {
				// 如果购物车没有商品
				$(".cartnum>span").text(0);
			}
			//存放分栏的商品信息
			var CategoryHTML = '', categoryArr = [];
			var goodblockHTML = '';		//分栏商品模板
			var _htmlArr = [];	//存放对应分类数据的数组
			var searchArr = [];		//存放搜索用数据

			/***************** 数据遍历 -- 开始 ************************/
			// 获取商品分类
			var _cate;
			if($("#_cate").val()){
				//有数据
				_cate = JSON.parse($("#_cate").val());
				// console.log(_cate);
				// 遍历分类
				for(var i=0;i<_cate.length; i++){
					CategoryHTML += '<span class="tab" index='+i+'>'+ _cate[i].name +'</span>';
					categoryArr.push(_cate[i].name);
				}

				/*
					遍历模板
				 */
				for(var i=0; i<_cate.length; i++){
					goodblockHTML += 
						'<div class="goodsBlock" index='+i+'>'+
						  '<div class="goods" >'+
							<!-- /*所有商品*/ -->
							'<div class="goodstitle">'+
								'<h3><span>——</span> 特惠专区 <span>——</span></h3>'+
							'</div>'+
							'<div class="allgoods">'+
								'<ul></ul>'+
								'</div>'+
							'</div>'+
						'</div>';
				}

				// 横线
				var _lineHTML = '<div id="line"></div>';
				$("#header").html(CategoryHTML+ _lineHTML);
				$("#content").append(goodblockHTML);

			}else{
				$("#header").html('暂无分类');
				console.log('暂无分类');
			}
			// 顶部滚动过渡效果
			$("#header").css({width: ($("#header>span").length+2)*20 + 'vw'});
			/*
				遍历商品
			 */
			var _goods;
			if($("#_goods").val() != 'null'){
				//有数据
				_goods = JSON.parse($("#_goods").val());
				// console.log(_goods);
				if(_cate){
					for(var i=0;i<_cate.length; i++){
						_htmlArr[[i]] = '';		//使用前先初始化
						searchArr[[i]] = '';		//使用前先初始化
						for(var j=0; j<_goods.length; j++){
							if(_goods[j].cid == _cate[i].id){	//对应分类下有商品
								// console.log(_goods[j].cid, _cate[i].id);
								searchArr[i] += '<a href="javascript:;" goods_gid="'+_goods[j].gid+'">'+
										'<p>'+ _goods[j].name +'</p>'+
									'</a>';

								_htmlArr[i] += 
									'<li>'+
										'<a class="pic" goods_gid="'+_goods[j].gid+'" href="javasctipt:;" cid="'+ i +'">'+
											'<img src="/Uploads/'+_goods[j].path+'" alt="正在加载中...">'+
											'<p class="name">'+ _goods[j].name +'</p>'+
											'<b class="price">¥'+ _goods[j].price +'</b><span class="iconfont "></span>'+
										'</a>'+
										'<i class="iconfont icon-jiarugouwuche"></i>'
									'</li>';
							}else{
								_htmlArr[i] += '';
							}
						}
					}

				}
			}else{
				//无数据
				$(".allgoods>ul").html('<h3 style="text-align:center;padding:5% 0;">暂无内容，敬请期待！<div></div></h3>');
				console.log('暂无商品');
			}
			
			// 遍历偏移量
			for(var i=0; i<categoryArr.length; i++){
				$("#content").find('.goodsBlock').eq(i).css({left: i*100 +'vw'});
				// console.log($("#content").find('.goodsBlock').attr("index"))
			}
			/*
				如果第一页有内容则加载第一页
			 */
			console.log(_htmlArr)
			if(_htmlArr[0]){
				$(".allgoods>ul").eq(0).html(_htmlArr[0]);
				// console.log($("#content>div").eq(0).attr("index"))
			}else{
				$(".allgoods>ul").eq(0).html('<h3 style="text-align:center;padding:5% 0;">暂无内容，敬请期待！<div></div></h3>');
			}

			/***************** 数据遍历 -- 结束 ************************/
			
			/***************** 页面跳转 -- 开始 ************************/
			/*
				点击的时候记录当前点击的商品gid，传给商品详情页面
			 */
			$(".goodsBlock").on('click','.pic',function(){
				// 将当前商品id拼接到地址URL
				$(this).attr("href", "{{:U('Shop/shoppingdetail')}}?gid=" + $(this).attr("goods_gid"));
				// console.log($(this).attr('href'));
				// 跳转到商品详情页面
				location.href = $(this).attr('href');

				// 记录当前分类位置
				sessionStorage.setItem('shopCid', $(this).attr('cid'));
			})
			//点击轮播图片
			$("#slider").on('click','.pic',function(){

				// 将当前商品id拼接到地址URL
				$(this).attr("href", "{{:U('Shop/shoppingdetail')}}?gid=" + $(this).attr("goods_gid"));
				// 跳转到商品详情页面
				location.href = $(this).attr("href");
			})
			/*
				点击商品旁边的购物车图标
			 */
			$(".allgoods").on("click",".icon-jiarugouwuche",function(){
				var _this = $(this);
				// 获取商品id
				var gid = $(this).siblings(".pic").attr("goods_gid");
				console.log(gid);
				//添加点击效果
				$(this).addClass("numShow");
				$(".cartnum>span").addClass("numShow");
				setTimeout(function(){
					//移除点击效果
					_this.removeClass("numShow");
					$(".cartnum>span").removeClass("numShow");
				},500)
				//告诉后台添加到数据库
				$.ajax({
					url: '{{:U("ShoppingCart/shopAdd")}}',
					type: 'post',
					data: {'gid': gid,'num': 1},
					success: function(res){
						console.log('成功！ ',res);
						//更新购物车商品数量
	       				$(".cartnum>span").text(res);
	       				parent.layer.msg('已加入购物车！');
					},
					error: function(res){
						console.log('失败！ ',res);
	       				parent.layer.msg('加入购物车失败，请稍后再试！');
					}
				})
			})
			//点击搜索框旁的购物车图标跳转到购物车
			$('.cartnum').click(function(){
				location.href = '{{:U("ShoppingCart/index")}}';
			})

			/***************** 页面跳转 -- 结束 ************************/

			/*
				点击顶部导航栏，切换订单状态
			 */ 
			var len = 10;
			var ullen;	//记录当前分类的数据状态，有则不用重新生成
			var tabIndex;
			$("#header").on("click",'.tab',function(){
				tabContent($(this));
			});
			// 切换的函数
			function tabContent(_this){

				ullen = $(".allgoods").eq(_this.attr("index")).find("ul")[0].childElementCount;
				//如果当前分类下有商品, 且页面未生成，则添加数据，否则不改动
				if(_htmlArr[_this.attr("index")] && ullen < 1){	
					$(".allgoods>ul").eq(_this.attr("index")).html(_htmlArr[_this.attr("index")]);
					
				}else if(!_htmlArr[_this.attr("index")]){
					$(".allgoods>ul").eq(_this.attr("index")).html('<h3 style="text-align: center;padding:5% 0;">暂无内容，敬请期待！<div></div></h3>')
				}
				// console.log('ullen: ',ullen)
				$('#header>span').css('color','#5A5A5A').css('font-weight','400');
				_this.css('color','#373737').css('font-weight','400');

				/******* 切换联动 *******/

				//切换内容
				$("#content")
				.css({transition: '.5s ease',transform: 'translateX(-'+ _this.attr("index") +'00vw)'});
				//横线移动
				$("#line").css({left: _this[0].offsetLeft+_this[0].clientWidth/2-$("#line")[0].clientWidth/2 + 'px'});

				// 顶部滚动过渡效果
				// console.log($(this)[0].offsetLeft)
				var offset = _this[0].offsetLeft/2 - _this[0].offsetWidth/2;
				offset = Math.abs(offset) > this.offsetLeft/2 ? this.offsetLeft/2 : offset;

				// console.log('this.offsetLeft/2: ',_this[0].offsetLeft/2);
				// console.log('_this[0].offsetWidth/2: ',_this[0].offsetWidth/2);
				// console.log('offset: ',offset);
				_this.parents('#header')[0].style.transform = 'translateX(-'+ offset +'px)';

				/******* 切换联动 *******/
			}
			// console.log($('.tab')[0].offsetLeft+$('.tab')[0].clientWidth-$("#line")[0].clientWidth/2)
			// 页面加载时顶部分类横线位置初始化
			$("#line").css({left: $('.tab')[0].offsetLeft+$('.tab')[0].clientWidth/2-$("#line")[0].clientWidth/2 + 'px'});
			$('#header>span').eq(0).css('color','#373737').css('font-weight','600');


			/******************************* 搜索 ************************************/
			/*
				监听input内容实时搜索
			 */
			$(".search input").on('keyup', function(){
				_search($(this).val());
			})
			/*
				点击搜索
			 */
			$(".searchBtn").click(function(){
				_search($(this).siblings('input').val());

			})
			// 点击搜索内容存储 商品id 到地址栏URL 给 商品详情页面用
			$("#searchPanel").on('click', 'a', function(){

				// 将当前商品id拼接到地址URL
				$(this).attr("href", "{{:U('Shop/shoppingdetail')}}?gid=" + $(this).attr("goods_gid"));
				// 跳转到商品详情页面
				location.href = $(this).attr("href");
			})
			//搜索函数
			function _search(word){
				//searchArr: 所有商品的数据, 遍历商品的时候存进去的
				// console.log(word);
				if(word){
					// console.log(searchArr);
					$("#searchPanel").html('');	//每次输入都重新搜索
					//遍历适配的数据
					for(var i=0; i<searchArr.length; i++){
						if(searchArr[i].indexOf(word) > -1){
							$("#searchPanel").html(searchArr[i]);
						}
					}
					$("#searchPanel").fadeIn('fast');
					// console.log($("#searchPanel>a").length)
					// 没有匹配到商品
					if($("#searchPanel>a").length < 1){

						$("#searchPanel").html('没有找到你搜索的商品！');
					}
				}else{
					$("#searchPanel").html('^^换个姿势搜索看看^^');
					console.log('没有输入内容!')
				}
			}
			/******************************* 搜索 ************************************/

			// 状态恢复(点击过去商品详情后，回来商城首页)
			if(sessionStorage.getItem('shopCid')){
				var cid = Number(sessionStorage.getItem('shopCid'));
				// $('#content').css({
				// 	transform: 'translateX(-'+ cid +'00vw)'
				// })
				tabContent($('.tab').eq(cid));
				// 初始化
				sessionStorage.setItem('shopCid', '');
			}
		})

	</script>
	<script type="text/javascript" src="__PUBLIC__/Home/js/slide.js"></script>

</body>
</html>