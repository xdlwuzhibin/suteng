<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0,minimal-ui" />
  <meta charset="UTF-8">
  <title>报修主页</title>
  <link rel="stylesheet" href="__PUBLIC__/Home/css/resetstyle.css">
  <link rel="stylesheet" href="__PUBLIC__/Home/fonts/iconfont.css">
  <link rel="stylesheet" href="__PUBLIC__/Home/css/repaire/index.css">
</head>
<body>
  <div class="_repair">
    <div class="repairContainer">
      <form action="" method="post" enctype="multipart/form-data" id="form">
        <div class="repairTop">
          <ul>
            
            <li>
              <span>设备型号：</span>
              <p>
                <span class="device_code"></span>
              </p>
            </li>
            <li><span>日&emsp;&emsp;期：</span><p><input type="text" class="currentdate" id="currentdate" name="date" value="" placeholder="-- 请选择服务日期 --" readonly="readonly"></p></li>
            <li>
              <span>报修原因：</span>
              <p>
                <select name="reason" class="reason">
                    <option value ="volvo">-- 请选择报修原因 --</option>
                    <option value ="saab">更换滤芯</option>
                    <option value="opel">微信端无法控制水机</option>
                    <option value="audi">其他</option>
                </select>
              </p>
            </li>
          </ul>
        </div>
        <div class="repairMidd">
            <h3>请写下您对设备的宝贵建议<span>*</span></h3>
            <textarea name="content" id="suggestTxt" cols="30" rows="10"></textarea>
            <p>上传截图</p>
            <div class="repairPic">
              <i class="iconfont icon-tianjia"></i>
              <span>限3张内</span>
              <input name="pic" class="repair-sendpic file_upload" multiple="true" type="file" accept="image/png, image/jpeg, image/gif, image/jpg" >
              <div id="picShow"></div>
              <div class="hide"></div>
            </div>
        </div>
        <div class="repairFoot">
          <ul>
            <h3>联系方式</h3>
            <li>
              <label for="Lname">
                <span>姓&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;名：</span><input id="Lname" type="text" name="truename" value="" placeholder="请输入姓名">
              </label>
            </li>
             <li>
              <label for="Ltel">
                <span>电&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;话：</span><input id="Ltel" type="text" name="phone" value="" placeholder="请输入电话">
              </label>
            </li>
            <li>
              <label for="Laddr">
                <p>维修地址：</p>
                <textarea name="address" id="Laddr" cols="30" rows="10" placeholder="" ></textarea>
              </label>
            </li>
          </ul>
        </div>
        <div class="repairBtn">
          <input type="button" value="提交" class="btn">
        </div>
      </form>
    </div>
  </div>
  <link rel="stylesheet" href="__PUBLIC__/Admin/layui/css/layui.css" />
  <script src="__PUBLIC__/Home/js/laydate.js"></script>
  <script src="__PUBLIC__/Home/js/jquery-1.10.1.js"></script>
  <script src="__PUBLIC__/Home/js/public.js"></script>
  <script type="text/javascript" src="__PUBLIC__/Admin/layui/layui.js"></script>
  <script src="__PUBLIC__/Home/js/upFile.js"></script>
  <script type="text/javascript">
  $(function(){

    // 首页按钮
    !function(){
      // 创建 a 标签
      var home = document.createElement('a');
      home.innerText = '首\n页';
      
      home.href = '{{:U("Home/VipCenter/minepack")}}';
      home.setAttribute("id", 'back2Home');

      // 添加到页面
      document.body.appendChild(home);
      home.onclick = function(){
        home.style.background = '#aaa';
      }
      return
      // console.log(home)
    }()

    var device_now = sessionStorage.getItem("device_now");
    $(".device_code").text(device_now);
    // 选择日期
    $("#currentdate").click(function(){

      //选择服务日期，
      laydate.render({
        elem: '#currentdate', //指定元素
        show: true,
        format: 'yyyy年MM月dd日',
        btns: ['clear', 'confirm'],
        min: 1
      });

    })

    /*
      点击'提交'
     */
    $(".btn").click(function(){
      /*
          date : 日期,
          device_code : 设备id,
          reason : 报修原因,
          suggestTxt : 建议,
          truename : 姓名,
          phone : 电话,
          address : 报修地址
       */
      var nameReg = /^([a-zA-Z0-9_\u4e00-\u9fa5]){2,30}$/;
      var phoneReg = /^1[3|4|5|8][0-9]\d{4,8}$/;
      var addressReg = /^(?=.*?[\u4E00-\u9FA5])[\dA-Za-z\u4E00-\u9FA5]{6,}/;
      var date = $(".currentdate").val().replace(/[年月]/g,'-').replace(/[日]/,''),
          device_code = $(".device_code").text(),
          reason = $(".reason>option:selected"),
          content = $("#suggestTxt").val(),
          truename = $("#Lname").val(),
          phone = $("#Ltel").val(),
          address = $("#Laddr").val();

          console.log('device_code:', device_code + '\n' +
           'date:',date + '\n' + 'reason:', reason[0].innerText + '\n' + 
           'content:', content + '\n' + 'truename:', truename + '\n' + 
           'phone:', phone + '\n' + 'address:', address
           );

          //清空，防止多次点击提交
          formData.delete('device_code')
          formData.delete('date')
          formData.delete('reason')
          formData.delete('content')
          formData.delete('truename')
          formData.delete('phone')
          formData.delete('address')

          console.group();

          //重新添加
          formData.append('device_code', device_code)
          formData.append('date', date)
          formData.append('reason', reason[0].innerText)
          formData.append('content', content)
          formData.append('truename', truename)
          formData.append('phone', phone)
          formData.append('address', address)

          console.log(formData.getAll('device_code') + '\n' + formData.getAll('date') + '\n' +
           formData.getAll('reason') + '\n' + formData.getAll('content') + '\n' + 
           formData.getAll('truename') + '\n' + formData.getAll('phone') + '\n' + 
           formData.getAll('address') + '\n' + formData.getAll('UploadForm[]')
          );
          if(date && device_code.selectedIndex != 0 && reason.selectedIndex != 0 && content && truename && phone && address && filePic){
              console.log('通过！')

              /*
                 发送到后台
               */
              $.ajax({
                  url: '{{:U("Home/Repair/add")}}',
                  type: 'post',
                  data: formData,
                  cache: false,
                  processData: false,
                  contentType: false,
                  success: function(res){
                    console.log('请求成功！', res);
                    if(res.code == 200){
                      layuiHint('报修成功，请稍候将有专人处理！');
                      // 将当前历史记录替换为水机首页
                      history.pushState({}, null, '{{:U("Home/Index/index")}}');
                      setTimeout(function(){
                        location.href = '{{:U("VipCenter/minepack")}}';
                      },900);

                    }

                  },
                  error: function(res){
                    console.log('请求失败！', res);
                    layuiHint('系统遇到问题，请稍后重试！');

                  }
              })
            
          }else if($('.device_code')[0].selectedIndex == 0){
              console.log('请选择保修的设备！');
              layuiHint('请选择保修的设备！');
              return false;
              
          }else if(!date){
              console.log('请选择日期！');
              layuiHint('请选择日期！');
              return false;

          }else if($('.reason')[0].selectedIndex == 0){
              console.log('请选择报修原因！');
              layuiHint('请选择报修原因！');
              return false;
              
          }else if(!content){
              console.log('希望您提供宝贵的建议！');
              layuiHint('希望您提供宝贵的建议！');
              return false;
              
          }else if(!filePic){
              console.log('请上传保修图片！');
              layuiHint('请上传保修图片！');
              return false;
              
          }else if(!nameReg.test(truename)){
              console.log('请输入正确格式的姓名！');
              layuiHint('请输入正确格式的姓名！');
              return false;
              
          }else if(!phoneReg.test(phone)){
              console.log('请输入正确格式的手机号码！');
              layuiHint('请输入正确格式的手机号码！');
              return false;
              
          }else if(!addressReg.test(address)){
              console.log('请输入正确格式的地址！');
              layuiHint('请输入正确格式的地址！\n只含有中文英文数字下划线等，不能有特殊字符');
              return false;
              
          }
    });
  })

  </script>
</body>
</html>                                                                                                                                                                                                                                                                      