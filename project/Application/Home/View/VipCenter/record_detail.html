<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name='viewport' content='width=device-width,initial-scale=1.0,user-scalable=no'>
	<title>工单详情</title>
	<link rel="stylesheet" href="__PUBLIC__/Home/css/resetstyle.css">
	<link rel="stylesheet" href="__PUBLIC__/Home/fonts/iconfontHome.css">
	<link rel="stylesheet" href="__PUBLIC__/Home/css/vipcenter/record_detail.css?v={{:time()}}">
	<script src='__PUBLIC__/Home/js/vue.min.js'></script>
	<script src='__PUBLIC__/Home/js/public.js'></script>
    <script src="__PUBLIC__/Home/js/vconsole.min.js"></script>
    <script>
        var vconsole = new VConsole();
    </script>
</head>
<body>
	<div id='recoed_detail'>
		<div class='content'>
			<ul class='timeline' v-for='d in detailList'>
				<li class='cfix'>
					<b class='fl' v-text='d.title'></b>
					<span class='fr' v-text='d.time'></span>
				</li>
				<li v-html='d.content'></li>
			</ul>
		</div>
		<p class='notice' :style='{display: noticestyle}' v-text='notice'></p>
		<button :style='{display: showEval}' class='evaluate' @click='evaluate'>评价</button>
		<div class='evalPanel' :style='evalPanel'>
			<!-- <h3>评论本次服务</h3> -->
			<p>工单号：&nbsp;&nbsp;&nbsp;<span v-text='workid'></span></p>
			<p>安装人员：<span v-text='name'></span></p>
			<ul>
				<li class='xinx'>
					<span class="iconfont icon-xingxing" :class='{activeClass: star >= 1}' @click='xingx(1)'></span>
					<span class="iconfont icon-xingxing" :class='{activeClass: star >= 2}' @click='xingx(2)'></span>
					<span class="iconfont icon-xingxing" :class='{activeClass: star >= 3}' @click='xingx(3)'></span>
					<span class="iconfont icon-xingxing" :class='{activeClass: star >= 4}' @click='xingx(4)'></span>
					<span class="iconfont icon-xingxing" :class='{activeClass: star == 5}' @click='xingx(5)'></span>
				</li>
				<li class='text'>
					<span v-for='t in textList' v-text='t.desc' :tid='t.id' @click='textSelect($event)'></span>
				</li>
				<li class='say'>
					<!-- <label for="">其他想对师傅说的话</label> -->
					<textarea name="" id="" cols="30" rows="7" placeholder="想对安装师傅的悄悄话，大胆说出来吧" v-model='text'></textarea>
				</li>
				<p class='noti'>仅限120字以内</p>
				<p>
					<i :class='nonameclass'></i>
					<label for="noname" @click='noname'>匿名提交</label>
				</p>
				<button class='evaluate' :style='{display: showEval}' @touchend='upEval'>提交</button>
			</ul>
		</div>
	</div>
	<!-- <div class="notic">
		<i class="iconfont icon-dagouyouquan"></i>
		<p>评价成功</p>
		<p>感谢你们对我们服务的支持！</p>
	</div> -->
	<script type="text/javascript" src="__PUBLIC__/Admin/layui/layui.js"></script>
	<script src="__PUBLIC__/Home/js/jquery-1.8.3.min.js"></script>
	<script>
		var recoed_detail = new Vue({
			el: '#recoed_detail',
			data () {
				return {
					notice: '正在加载...',
					noticestyle: 'block',
					workid: GetQueryString('workid'),
					name: '',			// 处理人
					detailList: [],
					showEval: '',	// 是否显示评价按钮
					evalPanel: '',		// 评价面板的样式
					starList: [],		// 所有星星的数据	
					textList: [],		// 对应星星的选项数据
					star: 5,			// 星星数量
					text: '',			// 对安装师傅说的话
					nonameclass: 'iconfont icon-fangxingweixuanzhong',
				}
			},
			mounted() {
				
			},
			created (){
				var vm = this;
				// 获取详情数据
				vm.getDetail(vm.workid);

				hashchangeFn(function(hash){
					if(hash.indexOf('#evaluate') < 0){
						// 隐藏
						document.title = '工单详情';
						vm.evalPanel = 'transform:translateY(100%)';
					}else{
						document.title = '服务评价';
						// 显示
						vm.evalPanel = 'transform:translateY(0%)';
					}
				})
 
				// 监听hashchange事件
				function hashchangeFn(callback) {
					var haschangeflag = false;
					window.addEventListener('hashchange', function(){
						haschangeflag = true;
						callback(location.hash);
					}, false);
					// console.log('haschangeflag: ',haschangeflag);
					// console.log('hash: ',location.hash);
					// 刷新保持
					if(!haschangeflag){
						callback(location.hash);
					}
				}
				
			},
			methods: { 
				// 获取详情数据
				getDetail (workid) {
					var vm = this;
					console.log('workid: ',workid);
					$.ajax({
						url: getURL('Home', 'vipCenter/showWorkTimeInfo'),
						type: 'post',
						data: {number: workid},
						success: function(res){
							console.log('res: ',res);
                            if(res.status == 200){
                            	vm.name = res.name;
                            	if(res.data && res.data.length){
                            		vm.noticestyle = "none";
									vm.detailList = res.data;
									
								}else{
                            		vm.notice = "查无数据";
									layuiHint('查无数据');
								}
								if(res.evaluaction){
									// 需要评价
									vm.showEval = 'block';
									// 获取评价的数据
									vm.getEvaluate(workid);
								}
							}else{
								layuiHint(res.msg);
							}
                        },
						error: function(err){
							console.log('err: ',err);
						}
					})
				},
				// 获取评论的数据
				getEvaluate (workid) {
					console.log('workid: ',workid);
					var vm = this;
					$.ajax({
						url: getURL('Home', 'Work/getEvaluate'),
						type: 'get',
						data: {number: workid},
						success: function(res){
							console.log('评论星星数据res: ',res);
							vm.starList = res.data;
							// 五星
							vm.textList = res.data[5][0];
						},
						error: function(err){
							console.log('err: ',err);
						}
					})
				},
				// 点击评论按钮
				evaluate () {
					var vm = this;
					vm.evalPanel = 'transform:translateY(0);';
					location.href = location.href + '#evaluate';
				},
				// 点击星星
				xingx (index) {
					this.star = index;
					console.log('star: ',this.star);
					var evalel = document.querySelectorAll('.eval');
					for(var i=0; i<evalel.length; i++){
						evalel[i].setAttribute('class', '');
					}
					// 根据星星数量显示不同的选项
					this.textList = this.starList[this.star][0];

				},
				// 评价多选
				textSelect (e) {
					var el = e.currentTarget;
					var elclass = el.getAttribute('class');
					if(elclass == 'eval'){
						el.setAttribute('class', '');
					}else{
						el.setAttribute('class', 'eval');
					}
				},
				// 提交评论数据
				upEval () {
					var vm = this;
					var info = {};		// 提交的数据
					var evalidArr = [];
					var textEval = document.querySelector('.text').querySelectorAll('.eval');
					// 遍历评论选项的id
					for(var i=0; i<textEval.length; i++){
						evalidArr.push(textEval[i].getAttribute('tid'))
					}
					if(!evalidArr.length){
						layuiHint('请至少选择一个评价');
						return
					}
					info = {
						workid: vm.workid,		// 工单id
						star: vm.star,			// 评价星星数量
						evalid: evalidArr,		// 评价选项id集合
					};
					// 对安装师傅说的话
					if(vm.text){
						console.log('vm.text.length: ',vm.text.length);
						if(vm.text.length > 120){
							layuiHint('仅限120字以内');
							return
						}
						info['text'] = vm.text;
					}
					console.log('info: ',info);
					// 提交评论数据
					$.ajax({
						url: getURL('Home', 'VipCenter/evaluAction'),
						type: 'post',
						data: info,
						success: function(res){
							console.log('res: ',res);
							if(res.status == 200){
								history.replaceState({}, null, '{{:U("Home/VipCenter/service_record")}}');
								document.body.innerHTML = '<div class="notic">'+
									'<i class="iconfont icon-dagouyouquan"></i>'+
									'<p>评价成功</p>'+
									'<p>感谢你们对我们服务的支持！</p>'+
								'</div>';
								setTimeout(function(){
									location.reload();
								},3000)
							}else{
								layuiHint(res.msg);
							}
						},
						error: function(err){
							console.log('err: ',err);
							layuiHint('系统遇到问题，请稍后再试');
						}
					})
				},
				noname () {
					if(this.nonameclass.indexOf('xuanzhongduigou') < 0){
						this.nonameclass = 'iconfont icon-xuanzhongduigou';
					}else{
						this.nonameclass = 'iconfont icon-fangxingweixuanzhong';
					}
					
				}
			}
		})
	</script>
</body>
</html>