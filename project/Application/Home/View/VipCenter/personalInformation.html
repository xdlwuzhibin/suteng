<!DOCTYPE html>
<html lang="en">
<head>
	<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0,minimal-ui" />
	<meta charset="UTF-8">
	<title>个人信息</title>
	<link rel="stylesheet" href="__PUBLIC__/Home/css/resetstyle.css">
	<link rel="stylesheet" href="__PUBLIC__/Home/fonts/iconfont.css">
	
	<style>
		.container{
			width:92%;
			position: relative;
			margin:0 auto;
		}
		.Information h3{
			font-size: 0.75rem;
			margin: 0.666667rem 0;
			color: 373737;
		}
		.Information label {
			display: block;
			width: 100%;
			height: 3rem;
		}
		.Information label i{
			display: inline-block;
		    width: 8%;
		    font-size: 1.2rem;
		    color: #307DBB;
		    padding: 0.4rem 0 0;
		    font-weight: 550;
		}
		.Information label div{
			float: right;
			width: 90%;
			border-bottom: 1px solid #838383;
			display: inline-block;
		}
		.Information label div span{
			display: inline-block;
		    width: 29%;
		    text-align: right;
		    line-height: 3vh;
		    font-size: 0.72rem;
		    margin-left: -0.32rem;
		}
		.Information label div input,.Information label div select{
			background: #fff!important;
			font-size: 0.72rem;
		    width: 68%;
		    border: none;
		    height: 1.5rem;
		    padding-left:0.2rem;
		    margin-bottom: 0.1rem;
		    color: #737373;
		    appearance:none;
			-moz-appearance:none;
			-webkit-appearance:none;
		}
		.Information label div select{
			appearance:none;
		  -moz-appearance:none;
		  -webkit-appearance:none;
		}
		select::-ms-expand { display: none; }
		select::-webkit-expand { display: none; }
		select::expand { display: none; }

		.bandBtn{
			width: 100%;
			position: absolute;
			/*bottom: 6rem;*/
			border-radius: 0.106667rem;
			padding:3.9rem 0 0;
		}
		.bandBtn input{
			height: 1.9rem;
			width: 86vw;
			text-align: center;
			display: block;
			font-size: 0.82rem;
			border-radius: 0.2rem;
			border:none;
			margin:0 auto;
			color: #fff;
			background: #2EB6AA;

		}
      .layui-laydate, .layui-laydate-main{
        width: 98vw !important;
        left: 50%;
        /*transform: translateX(-49vw);*/
      }
      .laydate-footer-btns {
        width: 50%;
        display: flex;
        position: relative !important;
        right: 9vw !important;
        top: 0 !important;
        align-items: center;
      }
      .laydate-btns-clear,
      .laydate-btns-now,
      .laydate-btns-confirm {
        width: 33.33%;
        display: inline-block;
        padding: 10% !important;
      }
      .layui-laydate-content table {
        width: 90%;
        position: relative;
        left: 50%;
        margin-left: -45%;
      }
      .layui-laydate-footer {
        display: flex !important;
        justify-content: flex-end;
        height: auto;
      }
      .laydate-footer-btns span {
        display: flex !important;
        align-items: center;
        justify-content: center;
        margin: 0 10px !important;
      }

		/*兼容解决*/
		@media screen and (max-height:520px) {
			.bandBtn {

		    padding: 2.5rem 0 0;
		    
			}
		}

	</style>
</head>
<body>
	<div class="container">
		<form id="form" action="" method="post">
			<div class="Information">
				<h3>个人信息</h3>
				<label for="name" class="">
					<i class="iconfont icon-wode1"></i>
					<div >
						<span>姓&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;名：</span><input name="name" id="name" type="text" value="{{$user_device['name']}}">
					</div>
				</label>
				<label for="sex">
					<i class="iconfont icon-weibiaoti-"></i>
					<div >
						<span>性&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;别：</span><select name="sex" >
							<switch name="user_device.sex">
							    <case value="0">
				    				<option value="0">男</option>
									<option value="1">女</option>
							    </case>
							    <case value="1">
							    	<option value="1">女</option>
				    				<option value="0">男</option>
							    </case>
							    <default />
							    	<option value="0">男</option>
									<option value="1">女</option>
							</switch>
	   					</select><!--下拉选择-->
					</div>
				</label>
				<label for="birth">
					<i class="iconfont icon-shengridangao2-copy"></i>
					<div >
						<span>生&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;日：</span><input name="birth" class="dateSelect" id="birth" placeholder="请选择生日年月" type="text" value="{{$user_device['birth']}}"><!--日期插件-->
					</div>
				</label>
				
				<label for="tel">
					<i class="iconfont icon-shouji2-copy"></i>
					<div >
						<span>手机号码：</span><input id="tel" name="phone" type="text" value="{{$user_device['phone']}}" >
					</div>
				</label>
				
				<label for="addr">
					<i class="iconfont icon-dizhi"></i>
					<div >
						<span>住&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;址：</span><input name="address" id="addr" type="text" value="{{$user_device['address']}}">
					</div>
				</label>
			</div>
			<div class="bandBtn">
				<input id="save" type="button" value="保存" readonly="readonly">
			</div>
		</form>
	</div>
  	<script src="__PUBLIC__/Home/js/laydate.js"></script>
	<script src="__PUBLIC__/Home/js/jquery-1.10.1.js"></script>
	<script type="text/javascript" src="__PUBLIC__/Admin/layui/layui.js"></script>
	<link rel="stylesheet" href="__PUBLIC__/Admin/layui/css/layui.css" />
	<script src="__PUBLIC__/Home/js/public.js"></script>
	<script type="text/javascript">
		$(function(){
			var machineNo;
			var href = location.href;
			// 绑定设备
			if(href.indexOf('?machineNo=') > -1){
				$('#name').val('');
				$('#birth').val('');
				$('#tel').val('');
				$('#addr').val('');
				$('#addr').text('');
				machineNo = href.substr(href.indexOf('?machineNo=')+11);
			}
			$(".dateSelect").click(function(){
				//年月范围选择
				laydate.render({ 
				  elem: '.dateSelect',
				  show: true,
				  max: new Date().getTime()
				});
			})
			$('#name').change( function() {
			  	// 这里可以写些验证代码
			  	var name = $(this).val();
			  	if(name==name.match(/^[a-zA-Z\u4e00-\u9fa5]{2,30}$/u)){// 纯中文姓名支持支持 /^[\u4e00-\u9fa5]{2,30}$/u
			  		console.dir('验证通过');
			  	}else{
			  		layuiHint('请输入真实的姓名！');
			  	}
			});

			$('#tel').change( function() {
			  	// 这里可以写些验证代码
			  	var phone = $(this).val();
			  	var rephone = phone.match(/^1((((3[0-35-9])|([5|8][0-9])|(4[5|7|9])|66|(7[3|5-8])|(9[8|9]))\d)|(34[0-8]))\d{7}$/);
			  	if(rephone){
				  	if(phone==rephone[0]){
				  		console.dir('验证通过');
				  	}else{
				  		layuiHint('请输入正确的手机号码！');
				  	}	
			  	}else{
			  		layuiHint('请输入正确的手机号码！');
			  	}

			});

			$('#addr').change( function() {
			  	// 这里可以写些验证代码
			  	var addr = $(this).val();
			  	if(addr==addr.match(/^[\w\-\u4e00-\u9fa5]{6,255}$/u)){// 公司地址，不为空时验证，数字字母下划线横线中文 6-255位
			  		console.dir('验证通过');
			  	}else{
			  		layuiHint('地址格式不正确！');
			  	}
			});
			
			// 点击保存
			$("#save").click(function(){
				
				// formdata
				var data = new FormData(document.getElementById("form"));

				if(!(nameReg.test($('#name').val()))){
					layuiHint("请输入真实的姓名");
					return;

				}else if(!$("#birth").val()){
					layuiHint("请选中您的生日");
					return;

				}else if(!(phoneReg.test($('#tel').val()))){
					layuiHint("请输入正确的手机号码");
					return;

				}else if(!(addressReg.test($('#addr').val()))){
					layuiHint("请输入详细地址！");
					return;

				}
				if(machineNo){
					// 绑定设备
					bindFn(function(res){
						if(res.binddevice){
							// 保存信息
							saveFn(data);
						}
					});
				}else{
					// 保存信息
					saveFn(data);
				}
				
			});
			function saveFn(data){				
				// 保存信息
				$.ajax({
					url: 'infomationAction',
					type: 'post',
					async: false,
			        cache: false,
			        contentType: false,
			        processData: false,
					data: data,
					success: function(res){
						if(res.code == 200){
							layuiHint(res.msg);
							// 替换当前历史记录为首页
							history.replaceState({}, null, "{{:U('Home/Index/index')}}");
							setTimeout(function(){
								// 跳转到我的钱包
								location.href="{{:U('Home/VipCenter/minepack')}}";	
							},500);	
						}else{
							layuiHint(res.msg);
						}
						
					},
					error: function(res){
						console.log('失败!', res)
					}
				})
			}
			function bindFn(callback){
				// 绑定设备
				$.ajax({
			    	url:"{{:U('Device/bind')}}",
			    	type:"post",
			    	data:{device_code: machineNo},
			    	dataType:'json',
			    	success:function(data){
			    		console.log(data);
						if(data.code == 200 ){
							layuiHint('绑定成功！');
							callback({binddevice: true});
							
						}else{
							layuiHint(data.msg);
							callback({binddevice: null});
						} 
			    	},
			    	error:function(jqXHR, textStatus, errorThrown){

	    				layuiHint("绑定失败" + jqXHR.status + textStatus + errorThrown);
						callback({binddevice: null});
	    				return
			    		//console.log(jqXHR.status);
			    	}
			    });
			}

		})
	</script>
	
</body>
</html>                                                                                                                                                                                                                                                                      