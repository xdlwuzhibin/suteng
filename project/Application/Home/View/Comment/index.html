<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0,minimal-ui" />
	<meta http-equiv="X-UA-Compatible" content="ie=edge" />
  	<link rel="stylesheet" href="__PUBLIC__/Home/css/resetstyle.css">
  	<link rel="stylesheet" href="__PUBLIC__/Home/css/comment/index.css">
 	<link rel="stylesheet" href="__PUBLIC__/Home/fonts/iconfont.css">
	<title>发表评论</title>
</head>
<body>
	<div class="commentcontain">
		<form id="form" action="" method="post" enctype="multipart/form-data">
			<div class="xuanping clearfix">
				<div class="pingpic"><img src="" alt=""></div>
				<!-- 商品ID -->
				<!-- <input type="hidden" name="gid" value=""> -->
			    <div class='everyItem'>
			        <input id="item1" type="radio" name="status" value="1" checked>
			        <label for="item1"></label>
			        <span>好评</span>
			    </div>
			    <div class='everyItem'>
			        <input id="item2" type="radio" name="status" value="2">
			        <label for="item2"></label>
			        <span>中评</span>
			    </div>
			    <div class='everyItem'>
			        <input id="item3" type="radio" name="status" value="3">
			        <label for="item3"></label>
			        <span>差</span>
			    </div>
			</div>
			<div class="shangping">
				<div class="shangpingpic">
					<label for="shopping">
						<textarea name="content" id="shopping" cols="30" rows="10" placeholder="请您对我们的商品做出评价……"></textarea>
					</label>
					<span>
						<i class="iconfont icon-tianjia"></i><em>限3张内</em>
						<input type="hidden" name='pic'>
						<div id="picShow"></div>
					</span>
					<input class="file_upload" name="pic[]" type="button" multiple="" accept="image/*" >
					
				</div>
			</div>
			<a href="javascript:;">
				<div class="saleBott">
					<input id="submit" type="button" value="提交">
				</div>
			</a>
		</form>
	</div>
	<script src="__PUBLIC__/Home/js/jquery.min.js"></script>
	<script type="text/javascript" src="__PUBLIC__/Admin/layui/layui.js"></script>
	<link rel="stylesheet" href="__PUBLIC__/Admin/layui/css/layui.css" />
  	<script src="__PUBLIC__/Home/js/public.js"></script>
  	<!-- <script src="__PUBLIC__/Home/js/upFile.js"></script> -->
  	<script src="__PUBLIC__/Home/js/wx_imgUpload.js"></script>
  	<script src="__PUBLIC__/Home/js/vconsole.min.js"></script>
	<script src="__PUBLIC__/Home/js/jweixin-1.2.0.js"></script>	
	<script>
		// var vConsole = new VConsole();
	  	console.log('VConsole is cool');
	  	$(function(){
			//将评论的商品信息显示到页面从我的订单~待评论传来
			if(sessionStorage.getItem("pinglunObj")){
				pinglunObj = JSON.parse(sessionStorage.getItem("pinglunObj"));
				// console.log(pinglunObj)
				$(".pingpic>img").attr("src",pinglunObj.pic);
			}
			//微信接口
			wx.config({
			    debug: false,
			    appId: '{{$wxinfo["appId"]}}',
			    timestamp: '{{$wxinfo["timestamp"]}}',
			    nonceStr: '{{$wxinfo["nonceStr"]}}',
			    signature: '{{$wxinfo["signature"]}}',
			    jsApiList: [
			      // 所有要调用的 API 都要加到这个列表中
				    'chooseImage',
			        'uploadImage',
			        'getLocalImgData',
			        'downloadImage'
			    ]
			});
			// 点击选择图片
			$('.file_upload').click(function(){
				// takePicture();
				// 浏览上传图片
				wxuploadimg(function(res){
				    console.log('res: ',res);

				    var $span = $("<span></span>");
				    var $span1 = $("<span>X</span>");
				    var $img = $('<img src="" alt="" />');

				    $img[0].width = "100%";
				    $img[0].height = "90%";
				    $img[0].src = res['src'];
				    
				    $span1.addClass("delPic");
				    $span1.css({zIndex: '999'});
				    $span.append($span1);
				    $span.append($img[0]);

				    // 显示图片
				    $('#picShow').append($span);
				    // 待发送给后台的图片id
				    $('input[name="pic"]').val(res.media_Id);
				});
			})
			/**
				点击提交
			*/
			var href = location.href;
			var orderid,gid;
			var successFlag = true;
			if(href.indexOf('?orderid=') > -1){
				orderid = href.substr(href.indexOf('?orderid=')+9);
				gid = JSON.parse(sessionStorage.getItem("pinglunObj")).gid;
			}
			$("#submit").on('click',function(){
				var formData = new FormData($('#form')[0]);	// 评论的数据
				formData.append('orderid',orderid);
				formData.append('orderid',gid);
				console.log(formData)
				var pic = $('#picShow>span').length;
				if(!$("#shopping").val()){
					layuiHint("请您对我们的商品做出评价呗");
					return
				} 
				if(!pic){
					// 没有图片
					$('input[name="pic"]').attr('name','nopic');
				}
				if(successFlag) {
					// 防止多次提交
					successFlag = false;
					//评分
					
					//发送数据到后台
					$.ajax({
						url: '{{:U("Comment/comment")}}',
						type: 'post',
						data: formData,
						async: false,
						cache: false,
						contentType: false,
						processData: false,
						success: function(res){
							console.log('res: ',res);
							// 发送到后台并返回结果时解除禁止点击
							successFlag = true;
							//评论成功后跳转
							if(res.code == 200){
								layuiHint('评论成功！');
								// 替换历史记录
								history.replaceState({},null,"{{:U('Home/VipCenter/index')}}");
								setTimeout(function(){
									location.href = "{{:U('Home/Order/index')}}";
								},500); 
							}else if(res.code == 605){
								layuiHint('你已经评论过了！');
								setTimeout(function(){
									location.href = "{{:U('Home/Order/index')}}";
								},500);
							}
						},
						error: function(err){
							// 发送到后台并返回结果时解除禁止点击
							successFlag = true;
							layuiHint('评论失败,请稍后再试！')
							console.log("err: ",err);
						}
					})
					
				}
				
			});
		})
	</script>
</body>
</html>