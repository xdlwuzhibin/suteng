<!DOCTYPE html>
<html lang="zh">
<head>
	<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0,minimal-ui" />
	<meta charset="UTF-8" />
	<title>开具发票</title>
	<link rel="stylesheet" href="__PUBLIC__/Home/css/resetstyle.css">
	<link rel="stylesheet" href="__PUBLIC__/Home/fonts/iconfont.css">
	<script src="__PUBLIC__/Home/js/jquery-1.10.1.js"></script>
	<script src="__PUBLIC__/Home/js/public.js"></script>
</head>
<style>
	
	body{
		font-size: 0.7rem; 
	}
	.icon-xuanze{
		color:#56aaf1;
	}
	.icon-kuang{
		font-size: 1.0rem!important;
	}
	
	div.tabContent>h3{
		display: block;
		padding:0.666667rem 5% 0;
		font-weight: 600;
		font-size: 0.72rem;
		color:#373737;
		font-weight: 500;
	}
	.tabTob{
		height: 1.6rem;
		border-bottom: 1px solid #F6F6F6;
		line-height: 1.6rem;
		padding:0.666667rem 5%;
		font-size: 0.72rem;
		font-weight: 500;
	}
	.tabContent>ul{
		border-bottom: 10px solid #f3f3f3;
		padding:0.6rem 5%;
	}
	.tabContent>ul>li{
		width: 33.33333%;
		height: 1.6rem;
		line-height: 1.2rem;
		float: left;
		color: #5a5a5a;
		font-size: 0.72rem;
	}
	.tabContent>ul>li>i{
		font-size: 1rem;
		display: inline-block;
		margin-right: 0.3rem ;
		height: 1.6rem;
		line-height: 1.6rem;
		
	}
	.son .item{
		margin-bottom: 0.266666rem;
		display: none;
	}
	
	.son .item:nth-child(1){
		display: block;
	}
	/*二级选项卡*/
	.secondParent>ul{
		display: block;
		width: 90%;
		padding:0 5%;
		border-bottom: 1px solid #F6F6F6;
	}
	.secondParent>ul>li{
		display: inline-block;
		width: 30%;
		height: 1.6rem;
		line-height: 1.6rem;
		color: #5a5a5a;
		font-size: 0.72rem;
		padding:0.3rem 0;
	}
	.secondParent>ul>li>i{
		font-size: 1rem;
		display: inline-block;
		margin-right: 0.3rem ;
		height: 1.6rem;
		line-height: 1.6rem;
	}
	.secondSon .secondItem{
		width: 100%;
		display: none;
		position: relative;
	}
	.secondSon .secondItem:first-child{
		display: inline-block;
	}
	.secondSon .secondItem>label>p{
		display: block;
		line-height: 1.6rem;
		border-bottom: 1px solid #F6F6F6;
		width: 90%;
		padding:0.3rem 5%;
	}
	.secondSon .secondItem p b{
		display: inline-block;
		width: 30%;
		float: left;
		height: 1.6rem;
		line-height: 1.6rem;
		color: #5a5a5a;
		font-size: 0.72rem;
		font-weight: 400;
	}
	.secondSon .secondItem p span{
		display: inline-block;
		width: 70%;
	}
	.secondSon .secondItem p span>input{
		width: 100%;
		height: 1.5rem;
		border: none;
	}
	/*二级选项卡的底部*/
	.secondFoot{
		margin-top: 3.8rem;
	}
	.secondBtn{
		width: 86%;
		height: 1.8rem;
		margin:0rem auto;
	}
	.secondBtn input{
		width: 100%;
		height: 1.8rem;
		border-radius: 0.2rem;
		background: #2EB6AA;
		border:none;
		color:#FFF;
		font-size: 0.82rem;
		letter-spacing: 0.1rem;
	}
	.secondTxt{
		width:90%;
		margin:2rem auto 0;
	}
	.secondTxt>p{
		font-size: 0.65rem;
		color: #5a5a5a;
		
	}
	.secondTxt>span{
		margin-top: 0.2rem;
		color: #5a5a5a;
		font-size: 0.65rem;
		
	}
	/*兼容*/
	@media screen and (max-height:520px){
		.secondFoot {
			margin-top: 4.5rem;
		}
		.secondTxt {
			margin: 1rem auto 0;
		}
		
	}
	
	
</style>
<body>
	<div class="tabContent">
		<h3>选择发票类型</h3>
		<ul id="tab" class="clearfix">
			<li><i class="iconfont  icon-xuanze"></i>电子发票</li>
			<li><i class="iconfont icon-kuang1"></i>纸质发票</li>
			<li><i class="iconfont icon-kuang1"></i>不开发票</li>
		</ul>
		<div class="son">
			<!-- 电子发票选项卡 -->
			<div class="item">
				<div class="tabTob"><p>发票信息</p></div>
				
				<div class="secondParent">
					<ul class="tabSecond">
						<li><i class="iconfont icon-xuanze"></i>个人</li>
						<li><i class="iconfont icon-kuang1"></i>公司</li>
					</ul>
				</div>
				<!-- 相应选择个人或公司 -->
				<div class="secondSon dianzi">
					<!-- 个人 -->
					<div class="secondItem personal">
						<label for="secperHead">
							<p>
								<b>发票抬头</b>
								<span><input id="secperHead" class="invoiceHead" type="text" placeholder="个人（必填）" name="invoiceHead"></span
							></p>
						</label>
						<label for="secperTel">
							<p>
								<b>电子邮箱</b>
								<span><input id="secperTel" class="mail" type="email" placeholder="请输入电子邮箱（必填）" name="email" ></span>
							</p>
						</label>
						<div class="secondFoot">
							<div class="secondBtn">
								<input type="button" value="确定" class="submit" index="1">
							</div>
						</div>
					</div>
					<!-- 公司 -->
					<div class="secondItem company">
						
						<label for="secperHead">
							<p>
								<b>发票抬头</b>
								<span><input id="secperHead" class="invoiceHead" type="text" placeholder="公司（必填）" name="invoiceHead"></span>
							</p>
						</label>
						<label for="secperAssociated"><p><b>税号</b><span><input id="Associated" class="invoiceHead" type="text" placeholder="税号（必填）" name="invoiceNum"></span></p></label>
						<label for="secperTel"><p><b>电子邮箱</b><span><input id="secperTel" class="mail" type="email" placeholder="请输入电子邮箱（必填）" name="email" ></span></p></label>
						<div class="secondFoot">
							<div class="secondBtn">
								<input type="button" value="确定" class="submit" index="1">
							</div>
						</div>
					</div>
				</div>
				
				<div class="secondTxt">
					<span>电子发票与纸质发票具备同等法律效力，可作为用户维权、 保修的有效凭据：</span>
				</div>
			</div>
			
			<!-- 纸质发票选项 -->
			<div class="item">
				<div class="tabTob"><p>发票信息</p></div>
				
				<div class="secondParent">
					<ul class="tabSecond">
						<li><i class="iconfont icon-xuanze"></i>个人</li>
						<li><i class="iconfont icon-kuang1"></i>公司</li>
					</ul>
				</div>
				<!-- 相应选择个人或公司 -->
				<div class="secondSon zhizhi">
					<!-- 个人 -->
					<div class="secondItem zhipersonal">
						<label for="zhisecpHead">
							<p>
								<b>发票抬头</b>
								<span><input id="zhisecpHead" class="invoiceHead" type="text" placeholder="个人（必填）"></span>
							</p>
						</label>
						<label for="zhisecpAddr"><p><b>收货地址</b><span><input id="zhisecpAddr" class="invoiceHead" type="text" placeholder="请输入地址（必填）"></span></p></label>
						<label for="zhisecpTel"><p><b>手机号</b><span><input id="zhisecpTel" class="phone" type="text" placeholder="请输入手机号（必填）"></span></p></label>
						<div class="secondFoot">
							<div class="secondBtn">
								<input type="button" value="确定" class="submit" index="1">
							</div>
							
						</div>
					</div>
					<!-- 公司 -->
					<div class="secondItem zhicompany">
						<div class="secondItem">
							<label for="zhisecpHead"><p><b>发票抬头</b><span><input id="zhisecpHead" class="invoiceHead" type="text" placeholder="个人（必填）"></span></p></label>
							<label for="zhisecpAssociated"><p><b>税号</b><span><input id="zhisecpAssociated" class="invoiceHead" type="text" placeholder="请输入税号（必填）"></span></p></label>
							<label for="zhisecpAddr"><p><b>收货地址</b><span><input id="zhisecpAddr" class="invoiceHead" type="text" placeholder="请输入地址（必填）"></span></p></label>
							<label for="zhisecpTel"><p><b>手机号</b><span><input id="zhisecpTel" class="phone" type="text" placeholder="请输入手机号（必填）"></span></p></label>
							<div class="secondFoot">
								<div class="secondBtn">
									<input type="button" value="确定" class="submit" index="1">
								</div>
							</div>
						</div>
					</div>
				</div>
				
				<div class="secondTxt">
					<span>电子发票与纸质发票具备同等法律效力，可作为用户维权、 保修的有效凭据：</span>
				</div>
			</div>
			
			<!-- 不开发票 -->
			<div class="item">
				<!-- <div class="tabTob"><p>发票信息</p></div> -->
				
				<div class="secondFoot">
					<div class="secondBtn">
						<input type="button" value="确定" class="submit" index="0">
					</div>
					
				</div>
			</div>
		</div>
		
		
	</div>
	<script type="text/javascript">
		$('#tab>li').click(function(){
			
			$('#tab>li>i').removeClass('iconfont icon-xuanze');
			
			$('#tab>li>i').addClass('iconfont icon-kuang1');
			
			$(this).children('i').removeClass('icon-kuang1');
			
			$(this).children('i').addClass('icon-xuanze');
			
			var i = $(this).index();
			
			$('div.son>div.item').hide();
			$('div.son>div.item').eq(i).show();
		});
		// 二级选项卡
		$('.secondParent').eq(0).find('li').click(function(){
			$('.secondParent').eq(0).find('i').removeClass('icon-xuanze').addClass('icon-kuang1');
			$(this).find('i').removeClass('icon-kuang1').addClass('icon-xuanze');
			var i = $(this).index();
			$('.secondSon').eq(0).children('.secondItem').eq(i).show().siblings().hide();
		});
		$('.secondParent').eq(1).find('li').click(function(){
			$('.secondParent').eq(1).find('i').removeClass('icon-xuanze').addClass('icon-kuang1');
			$(this).find('i').removeClass('icon-kuang1').addClass('icon-xuanze');
			var i = $(this).index();
			$('.secondSon').eq(1).children('.secondItem').eq(i).show().siblings().hide();
		});
		
		
		/*
		进入页面获取刚刚填写的发票信息，如果有的话
		*/
		var voiceArr = sessionStorage.getItem("voiceArr");

		var voiceArr = {};		//发票信息

		// 订单id
		var order_id = sessionStorage.getItem("order_id");

		// 判断是否点击提交按钮
		var clickFlag = false;
		/*
		点击’确定‘按钮
		*/
		$(".submit").click(function(){
			clickFlag = true;
			/*
			'type': 发票类型
			'info': 发票信息
			'voicehead': 发票抬头
			'phone': 手机号码
			*/
			
			//不开发票
			if($(this).attr("index") == 0){
				console.log('不开发票啊！');
				voiceArr.push({
					'type': "不开发票",
					'info': "",
					'voicehead': "",
					'phone': ""
				})
			}else {	
				//开发票	
				//发票类型
				var type = $("#tab").find(".icon-xuanze").parent().text();
				if(type == '电子发票'){
					var _voice = $(".secondParent").find(".icon-xuanze").parent().text().slice(0,2);
					console.log('电子发票: ',_voice);
					if(_voice == '个人'){
						// 判断信息是否输入
						var dianziHead = $(".personal label p span #secperHead").val();
						var dianziTel = $(".personal label p span #secperTel").val();
						if(dianziHead == '') {
							layer.msg("抬头必须输入!");
							return false;
						}else if(!dianziHead.match(/^[\w\-\u4e00-\u9fa5]{2,255}$/)) {
							layer.msg("规定输入两位以上的数字字母下划线横杆中文");
							return false;
						}
						if(dianziTel == '') {
							layer.msg("电子邮箱必须输入!");
							return false;
						}else if(!dianziTel.match(/^([a-zA-Z0-9_-])+@([a-zA-Z0-9_-])+(.[a-zA-Z0-9_-])+/)) {
							layer.msg("邮箱格式有误!");
							return false;
						}
						voiceArr = {
							'type': type,
							'info': _voice,
							'voicehead': dianziHead,
							'mail': dianziTel
						};
					}else{
						// 判断信息是否输入
						var dianziHead = $(".company label p span #secperHead").val();
						var dianziAssociated = $(".company label p span #Associated").val();
						var dianziTel = $(".company label p span #secperTel").val();
						if(dianziHead == '') {
							layer.msg("抬头必须输入!");
							return false;
						}else if(!dianziHead.match(/^[\w\-\u4e00-\u9fa5]{2,255}$/)) {
							layer.msg("规定输入两位以上的数字字母下划线横杆中文");
							return false;
						}
						if(dianziAssociated == '') {
							layer.msg("税号必须输入!"); 
							return false;
						}else if(!dianziAssociated.match(/^[A-Za-z0-9]{15}$|^[A-Za-z0-9]{17}$|^[A-Za-z0-9]{18}$|^[A-Za-z0-9]{20}$/)) {
							layer.msg("税号格式有误");
							return false;
						}
						if(dianziTel == '') {
							layer.msg("电子邮箱必须输入!");
							return false;
						}else if(!dianziTel.match(/^([a-zA-Z0-9_-])+@([a-zA-Z0-9_-])+(.[a-zA-Z0-9_-])+/)) {
							layer.msg("邮箱格式有误!");
							return false;
						}
						voiceArr = {
							'type': type,
							'info': _voice,
							'associated': dianziAssociated,//税号
							'voicehead': dianziHead,
							'phone': dianziTel
						};
					}
				}else{
					// 纸质发票
					var _voice = $(".secondParent").find(".icon-xuanze").parent().text().slice(2);
					if(_voice == '个人'){
						// 判断信息是否输入
						var zhizhiHead = $(".zhipersonal label p span #zhisecpHead").val();
						var zhizhiAssociated = $(".zhipersonal label p span #zhisecpAssociated").val();
						var zhizhiAddr = $(".zhipersonal label p span #zhisecpAddr").val();
						var zhizhiTel = $(".zhipersonal label p span #zhisecpTel").val();
						if(zhizhiHead == '') {
							layer.msg("抬头必须输入!");
							return false;
						}else if(!zhizhiHead.match(/^[\w\-\u4e00-\u9fa5]{2,255}$/)) {
							layer.msg("规定输入两位以上的数字字母下划线横杆中文");
							return false;
						}
						if(zhizhiAddr == '') {
							layer.msg("地址必须输入!");
							return false;
						}else if(!zhizhiAddr.match(/^(?=.*?[\u4E00-\u9FA5])[\d\u4E00-\u9FA5]+/)) {
							layer.msg("地址格式有误!");
							return false;
						}
						if(zhizhiTel == '') {
							layer.msg("电话必须输入!");
							return false;
						}else if(!zhizhiTel.match(/^1[3|4|5|8][0-9]\d{4,8}$/)) {
							layer.msg("号码格式有误!");
							return false;
						}
						voiceArr = {
							'type': type,
							'associated': zhizhiAssociated,
							'secpAddr': zhizhiAddr,
							'info': _voice,
							'voicehead': zhizhiHead,
							'phone': zhizhiTel
						};
					}else{
						// 判断信息是否输入
						var zhizhiHead = $(".zhicompany label p span #zhisecpHead").val();
						var zhizhiAssociated = $(".zhicompany label p span #zhisecpAssociated").val();
						var zhizhiAddr = $(".zhicompany label p span #zhisecpAddr").val();
						var zhizhiTel = $(".zhicompany label p span #zhisecpTel").val();
						if(zhizhiHead == '') {
							layer.msg("抬头必须输入!");
							return false;
						}else if(!zhizhiHead.match(/^[\w\-\u4e00-\u9fa5]{2,255}$/)) {
							layer.msg("规定输入两位以上的数字字母下划线横杆中文");
							return false;
						}
						if(zhizhiAssociated == '') {
							layer.msg("税号必须输入!");
							return false;
						}else if(!zhizhiAssociated.match(/^[A-Za-z0-9]{15}$|^[A-Za-z0-9]{17}$|^[A-Za-z0-9]{18}$|^[A-Za-z0-9]{20}$/)) {
							layer.msg("税号格式有误");
							return false;
						}
						if(zhizhiAddr == '') {
							layer.msg("地址必须输入!");
							return false;
						}else if(!zhizhiAddr.match(/^(?=.*?[\u4E00-\u9FA5])[\d\u4E00-\u9FA5]+/)) {
							layer.msg("地址格式有误!");
							return false;
						}
						if(zhizhiTel == '') {
							layer.msg("电话必须输入!");
							return false;
						}else if(!zhizhiTel.match(/^1[3|4|5|8][0-9]\d{4,8}$/)) {
							layer.msg("号码格式有误!");
							return false;
						}
						voiceArr = {
							'type': type,
							'associated': zhizhiAssociated,
							'secpAddr': zhizhiAddr,
							'info': _voice,
							'voicehead': zhizhiHead,
							'phone': zhizhiTel
						};
					}
				}
			}

			// 将发票信息保存到浏览器session中
			sessionStorage.setItem("voiceArr", JSON.stringify(voiceArr));
			// 提交发票信息到后台
			$.ajax({
				url: "{{:U('Pay/invoiceAdd')}}",
				data: {voiceArr: voiceArr, order_id: order_id},
				type: "post",
				success: function(res) {
					console.log("发票成功", res);
					window.location.href = "{{:U('Pay/payConfirm')}}";
				},
				fail: function(res) { 
					console.log("发票失败!", res);
				}
			})
		})
	</script>
</body>
<script src="__PUBLIC__/Admin/js/plugins/layer/layer.min.js"></script>
</html>
