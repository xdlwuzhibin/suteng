<!DOCTYPE html>
<html lang="en">
<head>
	<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0,minimal-ui" />
	<meta charset="UTF-8">
	<title>选择充值方式</title>
	<link rel="stylesheet" href="__PUBLIC__/Home/css/resetstyle.css">
	<link rel="stylesheet" href="__PUBLIC__/Home/fonts/iconfont.css">
	<style>
		body{
			font-size: 0.72rem;
			color:#373737;
		}
		._chooseMeal{
			width: 100%;
		}
		.chooseMeal{
			width: 90%;
			padding:0.533333rem 5% 0rem;
			margin-bottom: 3.2rem;
			position: relative;
		}
		.chooseContain h3{
			font-size: 0.8rem;
		    margin-bottom: 0.8rem;
		    font-weight: 600;
		}
		.chooseContain ul{
			width: 86%;
			margin:0 auto;
		}
		.chooseContain ul li{
			height: 1.333333rem;
			width: 100%;
			border:1px solid #E5E5E5;
			margin-top: 0.6rem;
			font-size: 0.766667rem;
			line-height: 1.333333rem;
			text-align: center;
			padding: 0.4rem 0;
			border-radius: 0.2rem;
			font-weight: 600;
		}
		.chooseContain ul li b{
			padding: 0 0.1rem;
		}
		.chooseFoot{
			position: fixed;
			bottom: 0;
			width: 100%;
		}
		.chooseFoot input{
			width: 100%;
			height: 1.8rem;
			background:#2EB6AA;
			color: #fff; 
			border:none;
			font-size: 0.82rem;
			letter-spacing: 0.1rem;
		}
		/*隐藏付款块*/
		.devicepay{
			box-sizing: border-box;
			width: 82%;
			float: right;
			padding:0.8rem 0.5rem;
			background: #E6E6E6;
			position: absolute;
			top:-0.65rem;
			border-radius: 0.2rem;
			display: none;
			-webkit-box-shadow: 1px 1px 3px; 
			-moz-box-shadow: 1px 1px 3px; 
			box-shadow: 1px 1px 3px;

		}
		.devicepay>span{
			font-size: 0.2rem;
			font-weight: 600;
			color:#F00;
		}
		.devicepay>span>em{
			padding-left:0.8rem; 
			font-size: 0.2rem;
			font-weight: 600;
			color:#F00;

		}
		.devicepay>i{
			display: inline-block;
		    width: 2rem;
		    height: 1rem;
		    line-height: 1rem;
		    font-weight: normal;
		    background: #F00;
		    color: #FFF;
		    border-radius: 0.2rem;
		    font-size: 0.3rem;
		    text-align: center;
		    float: right;
		}
		.deviceFoot{
			width: 100%;
			padding:0.266667rem;
			position: fixed;
			left: 0;
			bottom: 0;
			border-top: 1px solid #ccc;

		}
		.deviceFoot i{
			margin:0 0.4rem;
		}
		.deviceFoot span{
			font-size: 0.373333rem;
		}
		/*没有设备的页面*/
		.noDevice{
			display: none;
			width:100%;
			margin-top: 6.666667rem;
		}
		.noContainer{
			width: 5.333333rem;
			margin:0 auto;
			height: 5.333333rem;
			/*background: green;*/
			/*line-height: 2.666667rem;*/
			text-align: center;
		}
		.taocanSelectNow {
			color: #fff;
			background: #56AAF1;
		}
		.noContainer i{
			font-size: 4.0rem;
			color:#64A0F2;
		}
		.noContainer p{
			font-size: 0.8rem;
		}
		.icon-xuanze{
			color: #68B1F1;

		}

		/*付款页面*/
		.paystyle{
			position:fixed;
			top:0;
			left: 0;
			width: 100vw;
			height: 100vh;
			display: none;
		}
		.paystyleTop{
			width: 100vw;
			height: 10vh;
			background: #000;
			opacity: 0.3;
		}
		.payContain{
			position: absolute;
			bottom: 0;
			height: 100vh;
			width: 100vw;
			/*opacity: 0.5;*/
			z-index: 999;
			background: #FFF;
		}
		.payContain>.paytop{
			padding:0.5rem;
    		border-bottom: 1px solid #E5E5E5;
		}
		.paytop>.paytopLeft>i{
			float: left;
    		padding: 0.6rem 0;
    		margin-right: 4rem;
    		font-size: 1.5rem;
		}
		/*支付图标的颜色*/
		.icon-tubiao207{
            color:#f9df04;
            font-weight: 800; 
		}
		.icon-tubiao207-copy{
			color: #dadad5;
			 font-weight: 800;
			
		}
		.icon-z-weixin{
			color:#149E23;
			
		}
		.icon-zhifubao{
			color:#22A8FF;
			
		}
		.icon-yinlian{
			color:#1296DB;
			font-size: 1.3rem!important;
			
		}
		.paytop>.paytopRight{
			float: left;
    		text-align: center;
		}
		.icon-kuang1{
			color:#ccc;
		}
		.paytop>.paytopRight>h3{
			font-size: 0.9rem;
    		font-weight: 600;
    		padding: 0 0 0.5rem;
		}
		.paytop>.paytopRight>p{
			font-size: 0.9rem;
			font-weight: 600;
		}
		.paymidd>h3{
			padding:0.8rem;
		}
		.paymidd>ul>li{
			padding:0.6rem 0.5rem;
			border-bottom: 1px  solid #E5E5E5;
		}
		.paymidd>ul>li:nth-child(2){
			border-bottom: 6px  solid #E5E5E5;
			
		}
		.paymidd>ul>li>i{
			padding-right:0.4rem; 
			font-size: 1.2rem;
           
		}
		.paymidd>ul>li>span{
			float: right;
			font-size: 1rem;
		}
		/*底部按钮*/
		.payBott{
			width: 86vw;
			margin:5.5vh 7vw 0;
		}
		.payBott>input{
			border:none;
			padding:1.5vh  0;
			width: 86vw;
			background: #2EB6AA;
			border-radius:0.2rem;
			color: #FFF;
			font-size: 0.82rem;
			letter-spacing: 0.1rem;
		}
		/*模态框样式*/
	 .modelAll{width:100vw;height:100%;font-family: "mircoft yahei";font-size:14px;font-size: 0.7rem;line-height: 1; display: none;overflow: hidden;}
      .modal{position:absolute;left:0;right:0;z-index: -1;}
      .fade{opacity:0;top:-10%;display:block;-webkit-transition:top 0.3s linear;-o-transition:top 0.3s linear;transition:top 0.3s linear;}
      .fade.in{opacity:1;top:10%;}
      .modal-body{width:80%;margin:5rem auto;background-color: #fff;border-radius:0.5rem;}
      .modal-title{position:relative;height:40px;background-color: #D31145;line-height: 40px;border-bottom:1px solid #ccc;}
      .modal-backup{position:fixed;top:0;left:0;right:0;width:100%;height:100%;background-color: rgba(0, 0, 0, 0.5);z-index: 1000;display:none;}
      .modal-content>p{
      	padding:0.8rem;
      	text-align: center;
      	border-bottom:1px solid #E5E5E5;
      }
      .modal-content>p>a{
      	color:#64A0F2;
      }
      .modal-content>p>input{
      	border:none;
      	background: none;
      	color:#64A0F2;
      }
      .modal-content>p:nth-child(4){
      	border:none;
      }
      /*兼容解决*/
	@media screen and (max-height:520px) {
		.paymidd>ul>li {
	    	padding: 0.4rem 0.5rem;
		}
	}
		

	</style>
</head>
<body>
	<input type="hidden" value='{{$list}}' id="meal">
	<div class="_chooseMeal">
		<div class="chooseMeal">
			<div class="chooseContain">
				<h3>选择套餐</h3>
				<ul>
					<!-- <li class="taocanSelectNow">100元套餐含<b>1000L</b>流量</li>
					<li>100元套餐含<b>1000天</b>流量</li> -->
				</ul>
			</div>
		
		</div>
		<div class="chooseFoot">
			<input type="submit" value="立即购买">
		</div>
		<!-- 付款页面 -->
		<div class="paystyle">
			<div class="paystyleTop"></div>
			<div class="payContain">
				<div class="paytop clearfix">
					<div class="paytopLeft"><i class="iconfont icon-cuohao"></i></div>
					<div class="paytopRight">
						<h3>付款</h3>
						<p id="money">￥3620.00</p>
					</div>	
				</div>
				<div class="paymidd">
					<h3>选择支付方式</h3>
					<ul class="clearfix">
						<li><i class="iconfont icon-tubiao207"></i>金币<span class="iconfont icon-xuanze"></span></li>
						<li><i class="iconfont icon-tubiao207-copy"></i>银币<span class="iconfont icon-kuang1"></span></li>
						<li><i class="iconfont icon-z-weixin"></i>微信支付<span class="iconfont icon-kuang1"></span></li>
						<li><i class="iconfont icon-zhifubao"></i>支付宝支付<span class="iconfont icon-kuang1"></span></li>
						<li><i class="iconfont icon-yinlian"></i>银联<span class="iconfont icon-kuang1"></span></li>
					</ul>
				</div>
				<div class="payBott start">
					<input class=" start" type="submit" value="立即支付">
				</div>
			</div>
		</div>
		<!-- 模态框的内容 -->
		<div class="modal-backup">
			<div class="modelAll">
				<div class="modal fade">
					<div class="modal-body">
						<div class="modal-content">
							<p>您还没有绑定银行卡</p>
							<p class="close"><a href="#">去绑定</a></p>
							<p class="close"><a href="#">其他支付方式</a></p>
							<p><input class="close" type="submit" value="取消"></p>
						</div>
					</div>
				</div>
			
			</div>
		</div>
	</div>
	<script src="__PUBLIC__/Home/js/jquery-1.10.1.js"></script>
	<script src="__PUBLIC__/Admin/js/plugins/layer/layer.min.js"></script>
	<script src="__PUBLIC__/Home/js/public.js"></script>
	<!-- 微信支付支持JS部分代码 -->
	<script src="__PUBLIC__/Home/js/jweixin-1.2.0.js"></script>	                                                                                     
	<script>
		//微信接口
		wx.config({
		    debug: false,
		    appId: '{{$info["appId"]}}',
		    timestamp: '{{$info["timestamp"]}}',
		    nonceStr: '{{$info["nonceStr"]}}',
		    signature: '{{$info["signature"]}}',
		    jsApiList: [
		      // 所有要调用的 API 都要加到这个列表中
		      'chooseWXPay'
		    ]
		});
		
		var dingdanID;		//存储后台返回的订单号
		var meal, mealHTML = '';		//遍历套餐的数据
		if($("#meal").val()){
			//后台传过来的数据
			meal = JSON.parse($("#meal").val());
			
			//遍历套餐充值数据
			for(var i=0; i<meal.length; i++){
				mealHTML += '<li remodel="'+meal[i].remodel+'" flow="'+meal[i].flow+'" money="'+meal[i].money+'" tid="'+meal[i].id+'">'+ meal[i].describe +'</li>'
			}
			//将套餐数据添加到页面上
			$(".chooseContain>ul").html(mealHTML);
		}else{
			$(".chooseContain>ul").html('<h3 style="width:100%;height:50vh;text-align:center;padding:20vh 0">暂无数据</h3>');
		}
		
		/*
			点击立即购买，选择支付方式
		 */
		var money, tid, remodel;		//获取需要传到后台的套餐价钱，id, 套餐类型
		$('.chooseFoot>input').click(function(){
			// console.log($(".taocanSelectNow"))
			if($(".taocanSelectNow").length){
				$('.paystyle').slideDown("slow");
			}else{
	       		parent.layer.msg('请先选择购买的套餐');
			}
			money = $(".taocanSelectNow").attr("money");
			tid = $(".taocanSelectNow").attr("tid");
			console.log(money,tid)
			//发送请求让后台生成订单号
			$.ajax({
				url: '{{:U("Home/Mall/information")}}',				
				type: 'post',
				async: false,
				data: {'num':1,'id':tid,'money':money,'remodel':remodel},
				success: function(res){
					console.log('成功！ ', res);
					$("#money").text('￥'+money);
					//如果返回的是订单号
					if(typeof JSON.parse(res) == 'number'){
						dingdanID = res;
					}
				},
				error: function(res){
					console.log('失败！ ', res);			
				}
			})
		})
		/*
			点击立即支付
		 */
		$(".payBott").click(function(){
			console.log(dingdanID)
			$.ajax({
				url: '{{:U("Home/PaymentSystem/choosePay")}}',
				type: 'post',
				async: false,
				data: {order: dingdanID},
				success: function(res){
					console.log('成功！ ', res);
					if(res == -1){
						console.log('支付错误！');
						parent.layer.msg('支付错误！');
					}else{
						weixinPay(res);
					}
				},
				error: function(res){
					console.log('失败！ ', res);
	       			parent.layer.msg('系统出了一点小问题，请稍后再试！');			
				}
			})
		})

		// 选中背景改变
		$('.chooseContain>ul').on('click','li',function(){
			$(this).addClass('taocanSelectNow').siblings().removeClass("taocanSelectNow");
		})

		// 付款方式的单选框
		$('.paymidd>ul>li>span').click(function(){
			$('.paymidd>ul>li>span').removeClass('iconfont icon-xuanze').addClass('iconfont icon-kuang1');
			$(this).removeClass('iconfont icon-kuang1').addClass('iconfont icon-xuanze');
		})
		// 付款方式页面隐藏
		$('.paytop>.paytopLeft>i').click(function(){
			$('.paystyle').slideUp("slow");
		})
		// 模态框的js
		// $(function(){
		//   	$(".start").on("click",function(){
		//   	   $(".modelAll").css('display','block');
		//    	   $(".modal").addClass("in");
		//    	   $(".modal").css('z-index','1001');
		//    	   $(".modal-backup").css('display','block');
		//    });
		//   	$(".close").on("click",function(){
		//    	   $(".modal").removeClass('in');
		//    	   $(".modal").css('z-index','-1');
		//    	   $(".modal-backup").fadeOut('slow');
		//    });
		// 	})
		// .icon-kuang1{background:#57BFEE; }

      	/*
      		微信支付方法
      	 */ 
      	function weixinPay(res){
      		WeixinJSBridge.invoke(
      			'getBrandWCPayRequest',
      			JSON.parse(res),
      			function(res){
      				if(res.err_msg.substr(-2) == 'ok'){

       					parent.layer.msg('付款成功！');
      					//付款成功后的操作
      					setTimeout(function(){
      						location.href = '{{:U("PaymentSystem/paytosuccess")}}';
      					},500);
      					
      				}else if(res.err_msg.substr(-6) == 'cancel'){
      					//取消订单操作
      				}else{
       					parent.layer.msg('付款失败！');
      					//付款失败操作
      					setTimeout(function(){
      						location.href = '{{:U("PaymentSystem/paytofailed")}}';
      					},500);
      					
      				}
      			}
      		)
      	}
	</script>
</body>
</html>                                                                                                                                                                                                                                                                      
