<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0,minimal-ui" />
	<meta http-equiv="X-UA-Compatible" content="ie=edge" />
  	<link rel="stylesheet" href="__PUBLIC__/Home/css/resetstyle.css">
 	<link rel="stylesheet" href="__PUBLIC__/Home/fonts/iconfont.css">
	<script src="__PUBLIC__/Home/js/jquery-1.10.1.js"></script>
  	<script src="__PUBLIC__/Home/js/public.js"></script>
	<title>购物车</title>
</head>
<style>
	body{
		font-size: 0.7rem;
	}
	.shpingcarAll{
		padding-bottom: 5.6rem;
	}
	/*购物车无商品*/
	.noItem {
		width: 100%;
		height: 80vh;
		display: none;
		flex-flow: column;
		justify-content: center;
		align-items: center;
		padding: 2%;
	}
	.noItem>div {
		width: 4vmin;
		height: 4vmin;
		position: relative;
		border: 1vmin solid #aaa;
		border-radius: 50%;
		animation: nono 5s ease infinite;
	}
	@keyframes nono {
		from {
			opacity: 1;
			transform: scale(.2) translateY(0);
		}
		to {
			opacity: 0;
			transform: scale(1) translateY(-10vh);
		}
	}
	/*一个商品的样式*/
	.itemCar{
		padding: 1rem 3%;
		border-bottom: 10px solid #E5E5E5;
	}
	/*删除按钮的样式*/
	.itemCar>span{
		line-height: 8rem;
		border-bottom:10px solid #E5E5E5;
	}
	/*选中及图片*/
	.itemcarLeft{
		width: 40%;
		float: left;
	}
	.itemcarLeft>.xuanzhong{
		float: left;
	    padding: 2.35rem 0.2rem;
	    width: 15%;
	    text-align: center;
	    /*color: #56AAF1;*/
	}
	.itemcarLeft>.xuanzhong>.icon-kuang1{
		color:#ccc;
		font-size: .9rem;
	}
	.itemcarLeft>.xuanzhong>.icon-xuanze{
	    color: #56AAF1;
		font-size: .9rem;
	}
	.itemcarLeft>.carpic{
		border:1px solid #ccc;
		border-radius: 0.2rem;
		box-sizing: border-box;
		padding:1.2rem 0.3rem;
		width: 77%;
		float: right;
	}
	.itemcarLeft>.carpic>img{
		width: 100%;
	}
	/*文字说明及价格*/
	.itemcarRight{
		box-sizing: border-box;
		padding-left:0.5rem; 
		width: 60%;
		float: right;
	}
	.itemcarRight>h3{
		padding-bottom:0.2rem; 
	}
	.itemcarRight>.roTxt{
		font-size: 0.6rem;
   		line-height: 1rem;
	    overflow: hidden;
	    text-overflow: ellipsis;
	    display: -webkit-box;
	    -webkit-box-orient: vertical;
	    box-orient: vertical;
	    -webkit-line-clamp: 3;
	    line-clamp: 3;
	    color: #5A5A5A;
	}
	.itemcarRight>.roPrice{
		display: inline-block;
		padding: 0.7rem 0rem;
		width: 100%;
	}
	.itemcarRight>.roPrice>b{
		color: #F00;
	}
	.itemcarRight>.roPrice>span{
		float: right;
	}
	.itemcarRight>.roPrice>span>em{
		display: inline-block;
	    border: 1px solid #ccc;
	    padding: 0rem 0.2rem;
	    margin: 0 0.2rem;
	    font-size: 0.2rem;
	}
	 /*底部结算按钮*/
	 .shoppingcarBott{
	 	position: fixed;
	    bottom: 0;
	    width: 100%;
	    background: #FFF;	    
	    border-top: 1px solid #e0e0e0;   
	 }
	 .shoppingcarBott>p{
	 	display: inline-block;
	 	width: 70%;
	 	float: left;
	    box-sizing: border-box;
	 	padding: 0.5rem 0rem 0.5rem 3%;
	 }
	.shoppingcarBott>p>i{
		padding-right: 0.2rem;
		color: #ccc;
    	font-size: .9rem;
	}
	.shoppingcarBott>p>i.icon-xuanze{
		 color: #56AAF1;
	}
	.shoppingcarBott>p>span{
		padding-left: 0.8rem;

	}
	.shoppingcarBott>p>span>b{
		color: #F00;
	}
	.shoppingcarBott>input{
	 	float: right;
		height: 2rem; 
	    width: 30%;
	    border: none;
	    background: #2EB6AA;
	    color: #FFF;
	 }
	  /*商品数量*/
    .num {
        width: 40%;
        display: -webkit-box;
        display: -ms-flexbox;
        display: flex;
        -webkit-box-pack: center;
            -ms-flex-pack: center;
                justify-content: center;
        -webkit-box-align: stretch;
            -ms-flex-align: stretch;
                align-items: stretch;
    }

    .num>input {
        width: 33%;
        display: -webkit-box;
        display: -ms-flexbox;
        display: flex;
        -webkit-box-pack: center;
            -ms-flex-pack: center;
                justify-content: center;
        -webkit-box-align: center;
            -ms-flex-align: center;
                align-items: center;
        text-align: center;
        font-size: 1rem;
        border: none;
        -webkit-appearance: none;
        border-radius: 4px;
        /*background: #fff;*/
    }
    .num>.number {
        width: 33%;
        margin: 0 4px;
        text-align: center;
        border-radius: 4px;
        border: 1px solid #a4a4a4;
        font-size: .8rem;
    }
</style>
<body>
	<div class="shpingcarAll">
		<!-- 购物车没有商品时候显示 -->
		<div class="noItem">
			<h3>购物车空空如也</h3>
			<div></div>
		</div>
		<!-- <div class="itemCar clearfix" gid="1" > -->
			<!-- /*选中及图片*/ -->
			<!-- <div class="itemcarLeft clearfix ">
				<div class="xuanzhong "><i class="iconfont icon-kuang1"></i></div>
				<div class="carpic "><img src="__PUBLIC__/Home/images/comm_02.png" alt=""></div>
			</div> -->
			<!-- /*文字说明及价格*/ -->
			<!-- <div class="itemcarRight">
				<h3>RO膜</h3>
				<p class="roTxt">RO膜能够有效地去除水中钙、镁、 细菌、有机物、无机物、金属离子和 放射性物质放射性物质放射性物质放射性物质等</p>
				<p class="roPrice clearfix">
					<b class="price">￥<span>120.00</span></b>
					<span class="num">
						<input type="button" value="-" class="minus">
						<input class="number" type="number" value="1" min="1" max="19">
						<input type="button" value="+" class="plus">
					</span>
				</p>

			</div>
		</div> -->
	</div>
	<!-- 底部结算按钮 -->
	<div class="shoppingcarBott">
		<p><i class="iconfont icon-kuang1"></i>全选<span>合计：<b class="priceAll">￥<span>0</span></b></span></p>
		<input id="toPay" type="button" value="结算">
	</div>
	<script src="__PUBLIC__/Admin/js/plugins/layer/layer.min.js"></script>

	<script>
	$(function(){
		/*
			请求购物车列表数据
		 */ 
		var itemCarHTML = '';
		$.ajax({
			url: '{{:U("ShoppingCart/cart")}}',
			type: 'post',
			success: function(res){
				console.log("成功！", res);
				if(res){
					for(var i=0; i<res.length; i++){
						res[i].desc = !res[i].desc ? '暂无描述' : res[i].desc;
						itemCarHTML += '<div class="itemCar clearfix" gid="'+ res[i].gid +'"  index_id="'+ res[i].id +'">'+
							'<!-- 选中及图片 -->'+
							'<div class="itemcarLeft clearfix ">'+
								'<div class="xuanzhong "><i class="iconfont icon-kuang1"></i></div>'+
								'<div class="carpic "><img src="/Uploads/'+ res[i].path +'" alt=""></div>'+
							'</div>'+
							'<!-- 文字说明及价格 -->'+
							'<div class="itemcarRight">'+
								'<h3>'+ res[i].name +'</h3>'+
								'<p class="roTxt">'+ res[i].desc +'</p>'+
								'<p class="roPrice clearfix">'+
									'<b class="price">￥<span>'+ res[i].price +'</span></b>'+
									'<span class="num">'+
										'<input type="button" value="-" class="minus">'+
										'<input class="number" type="number" value="'+ res[i].num +'" min="1" max="19">'+
										'<input type="button" value="+" class="plus">'+
									'</span>'+
								'</p>'+
							'</div>'+
						'</div>';
					}
					// 添加到购物车页面
					$(".shpingcarAll").html(itemCarHTML);
				}else{
					// 购物车没有商品
					$(".noItem").css({display: 'flex'})
				}
			},
			error: function(res){
				console.log("失败！", res)
			}
		})
		/*
			结算
		 */
		$("#toPay").click(function(){
			var shopCar_data = [];
			var chooseGoods = $(".itemCar").find("i[class='iconfont icon-xuanze']");
			
			if($(".priceAll>span").text() != 0){
				for(var i=0; i<chooseGoods.length; i++){
					shopCar_data.push({
						'path': chooseGoods.eq(i).parents(".itemCar").find(".carpic>img").attr("src"),
						'desc': chooseGoods.eq(i).parents(".itemCar").find(".roTxt").text(),
						'name': chooseGoods.eq(i).parents(".itemCar").find(".itemcarRight>h3").text(),
						'gid': chooseGoods.eq(i).parents(".itemCar").attr("gid"),
						'num': chooseGoods.eq(i).parents(".itemCar").find(".number").val(),
						'price': chooseGoods.eq(i).parents(".itemCar").find(".price>span").text(),
						'money': parseFloat(chooseGoods.eq(i).parents(".itemCar").find(".price>span").text())*parseFloat(chooseGoods.eq(i).parents(".itemCar").find(".number").val())
					});
				}

				//清除其他页面的sessionStorage
				sessionStorage.setItem("lvxinData", '');
				sessionStorage.setItem("goods_data", '');
				
				// 将购物车选中的商品存到本地sessionStorage, 给订单确认页面使用
				sessionStorage.setItem("shopCar_data",JSON.stringify(shopCar_data));
				console.log(shopCar_data)
				
				// 发送ajax请求让后台生成订单号
				$.ajax({
					url: '{{:U("PaymentSystem/information")}}',
					type: 'post',
					data: {'data':JSON.stringify(shopCar_data)},
					success: function(res){
						console.log('成功！', res);
						sessionStorage.setItem('order_id',res);
						// 跳转到订单确认页面
						location.href = '{{:U("PaymentSystem/payConfirm")}}';
					},
					error: function(res){
						console.log('失败！', res);
					}
				})
			}else{
	       		parent.layer.msg('你还没选择购买的商品！');
			}
		})

		var priceAll = 0;
		/*
			 按加'+'号
		 */
		$(".shpingcarAll").on("touchend",'.plus',function(){
			var chooseGoods = $(".itemCar").find("i[class='iconfont icon-xuanze']");
			priceAll = 0;	//合计归零，后面重新计算
			// 获取数量
			var value = $(".number").val();
			$(this).siblings(".number")[0].value++;

			// 将金额实时更新到合计
			for(var i=0; i<chooseGoods.length; i++){
				if($(".itemCar").find("i[class='iconfont icon-xuanze']")){
					var itemCar = $(".shpingcarAll").find(".itemCar").eq(i);
					priceAll += parseFloat(itemCar.find(".price>span").text())*parseFloat(itemCar.find(".number").val())
				}
				// console.log('price: ',itemCar.find(".price>span").text())
				// console.log('num: ',itemCar.find(".number").val())
			}
			$(".priceAll>span").text(priceAll);
		});
		/*
			按减'-'号
		 */
		$(".shpingcarAll").on("touchend",".minus",function(){
			var chooseGoods = $(".itemCar").find("i[class='iconfont icon-xuanze']");
			priceAll = 0;	//合计归零，后面重新计算
			// 获取数量
			var value = $(".number").val();
			for(var i=0; i<$(this).siblings(".number").length; i++){
				$(this).siblings(".number").val() <= 1
				? 1
				: $(this).siblings(".number")[i].value--
			}
			// console.log($(this).siblings(".number")[0].value);
			// 将金额实时更新到合计
			for(var i=0; i<chooseGoods.length; i++){
				if($(".itemCar").find("i[class='iconfont icon-xuanze']")){
					var itemCar = $(".shpingcarAll").find(".itemCar").eq(i);
					priceAll += parseFloat(itemCar.find(".price>span").text())*parseFloat(itemCar.find(".number").val())
				}
				// console.log('price: ',itemCar.find(".price>span").text())
				// console.log('num: ',itemCar.find(".number").val())
			}
			$(".priceAll>span").text(priceAll);

		});
		// 商品左滑，出现删除按钮
       slipDel('.shpingcarAll','.itemCar','goodsnumbe');

       // 购物车删除
       $(".shpingcarAll").on("click",'.del', function(e){
       		var _this = $(this);
	       	console.log(e);
	       	var index_id = $(this).parents(".itemCar").attr("index_id");
	       	console.log(index_id)
	       	
	       	// 发送请求删除商品在数据库的数据
	       	$.ajax({
				url: '{{:U("ShoppingCart/cartDel")}}',
				type: 'post',
				data: {'id': index_id},
				success: function(res){
					console.log('成功！ ',res);
					// 移除当前删除商品的元素
	       			_this.parents('.itemCar').remove();
	       			parent.layer.msg('删除成功！');
				},
				error: function(res){
					console.log('失败！ ',res);
	       			parent.layer.msg('删除失败！');
				}
			})
       })

		// 选中框
		$('.shpingcarAll').on('click','.itemcarLeft>.xuanzhong>i',function(){
			var chooseGoods = $(".itemCar").find("i[class='iconfont icon-xuanze']");
			var _class=$(this).attr('class');

			// 无选择商品
			if(_class=='iconfont icon-xuanze'){
				$(this).removeClass('iconfont icon-xuanze').addClass('iconfont icon-kuang1');
				
				priceAll = 0;
				var chooseGoods = $(".itemCar").find("i[class='iconfont icon-xuanze']");
				// 实时将总价格更新到合计
				for(var i=0; i<chooseGoods.length; i++){
					
					priceAll += parseFloat(chooseGoods.eq(i).parents(".itemCar").find(".number")[0].value)*parseFloat(chooseGoods.eq(i).parents(".itemCar").find(".price>span").text());

					// console.log(chooseGoods.eq(i).parents(".itemCar").find(".number")[0].value);
					// console.log(chooseGoods.eq(i).parents(".itemCar").find(".price>span").text());
				} 
				// 将价格显示到合计
				$(".priceAll>span").text(priceAll);
			// 有选择商品
			}else{
				$(this).removeClass('iconfont icon-kuang1').addClass('iconfont icon-xuanze');
				priceAll = 0;
				var chooseGoods = $(".itemCar").find("i[class='iconfont icon-xuanze']");
				// 实时将总价格更新到合计
				for(var i=0; i<chooseGoods.length; i++){
					
					priceAll += parseFloat(chooseGoods.eq(i).parents(".itemCar").find(".number")[0].value)*parseFloat(chooseGoods.eq(i).parents(".itemCar").find(".price>span").text());

					// console.log(chooseGoods.eq(i).parents(".itemCar").find(".number")[0].value);
					// console.log(chooseGoods.eq(i).parents(".itemCar").find(".price>span").text());
				} 
				// 将价格显示到合计
				$(".priceAll>span").text(priceAll);
			}
			// 如果没有一个选中
			if(!$(".icon-xuanze").length){
				console.log('没了');
				$(".priceAll>span").text(0);
			}

			// 全部选中了
			if($(".itemCar").find(".icon-xuanze").length == $(".itemCar").length){
				$('.shoppingcarBott>p>i').removeClass('iconfont icon-kuang1').addClass('iconfont icon-xuanze');
			}else if($(".itemCar").find(".icon-xuanze").length != $(".itemCar").length){
				// 未全选
				$('.shoppingcarBott>p>i').removeClass('iconfont icon-xuanze').addClass('iconfont icon-kuang1');
			}
		})
		// 全选事件
		$('.shoppingcarBott>p>i').click(function(){
			var _quanclass=$(this).attr('class');
			
			// 全选
			if(_quanclass=='iconfont icon-kuang1'){
				$(this).removeClass('iconfont icon-kuang1').addClass('iconfont icon-xuanze');
				var _class=$('.itemcarLeft>.xuanzhong>i').attr('class');
				$('.itemcarLeft>.xuanzhong>i').removeClass(_class).addClass('iconfont icon-xuanze');

				priceAll = 0;
				var chooseGoods = $(".itemCar").find("i[class='iconfont icon-xuanze']");
				// 实时将总价格更新到合计
				for(var i=0; i<chooseGoods.length; i++){
					
					priceAll += parseFloat(chooseGoods.eq(i).parents(".itemCar").find(".number")[0].value)*parseFloat(chooseGoods.eq(i).parents(".itemCar").find(".price>span").text());

					// console.log(chooseGoods.eq(i).parents(".itemCar").find(".number")[0].value);
					// console.log(chooseGoods.eq(i).parents(".itemCar").find(".price>span").text());
				} 
				// 将价格显示到合计
				$(".priceAll>span").text(priceAll);
			}else{
				// 全不选
				$(this).removeClass('iconfont icon-xuanze').addClass('iconfont icon-kuang1');
				var _class=$('.itemcarLeft>.xuanzhong>i').attr('class');
				$('.itemcarLeft>.xuanzhong>i').removeClass(_class).addClass('iconfont icon-kuang1');

				priceAll = 0;
				var chooseGoods = $(".itemCar").find("i[class='iconfont icon-xuanze']");
				// 实时将总价格更新到合计
				for(var i=0; i<chooseGoods.length; i++){
					
					priceAll += parseFloat(chooseGoods.eq(i).parents(".itemCar").find(".number")[0].value)*parseFloat(chooseGoods.eq(i).parents(".itemCar").find(".price>span").text());

					// console.log(chooseGoods.eq(i).parents(".itemCar").find(".number")[0].value);
					// console.log(chooseGoods.eq(i).parents(".itemCar").find(".price>span").text());
				} 
				// 将价格显示到合计
				$(".priceAll>span").text(priceAll);
			}
			
		})
	})
    </script>
    
</body>
</html>