<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
	<link rel="stylesheet" href="__PUBLIC__/Home/css/resetstyle.css">
	<script src="__PUBLIC__/Home/js/public.js"></script>
	<script src="__PUBLIC__/Home/js/jquery-1.8.3.min.js"></script>
	<title>地址</title>
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}
		body {
			width: 100vw;
		    height: 100vh;
		    background: #eee;
			font-size: .7rem;
			overflow-x: hidden;
		}
		#content{
			margin-bottom: 7vh;
		}
		.noaddress {
			width: 100%;
			height: 60vh;
			display: flex;
			justify-content: center;
			align-items: center;
			position: relative;
			top: 20%;
			text-align: center;
		}
		.address {
		    background: #fff;
			border-bottom: 8px solid #eee;
		}
		.address>div>p {
			padding: 6%;
		}
		.address>div:not(:nth-of-type(1)) {
			border-top: 1px solid #eee;
		}
		.aTop>p>span:nth-of-type(1) {
			float: left;
		}
		.aTop>p>span:nth-of-type(2) {
			float: right;
		}
		.aTop>p>span:after {
			content: '';
			clear: both;
		}
		.aBottom {
			padding: 3% 6%;
		}
		.aBottom>div {
			display: flex;
			align-items: center;
		}

		.aBottom>div>label {
			width: 40%;
			margin: 0 4vw;
			white-space: nowrap;
		}
		.aBottom>div>p {
			width: 50%;
			display: inline-block;
			float: right;
			white-space: nowrap;
		}
		.aBottom>div>p:after {
			content: '';
			clear: both;
		}
		[id*="setAddress-"] {
			width: 5vmin;
			height: 5vmin;
			border-radius: 3px;
			border: 1px solid #dfdfdf;
			-webkit-appearance: none;
		}
		.setAddress[id*="setAddress-"]:checked {
			border: none;
			background: url('__PUBLIC__/Home/images/check.png') #56AAF1 no-repeat;
			background-size: 76%;
			background-position: center;
		}
		.edit, .del {
			display: inline-block;
			margin-left: 8vw;
			padding: 1% 4%;
			font-size: .6rem;
			border-radius: 6px;
			border: 1px solid #dfdfdf;
		}

        /*点击添加地址弹出的页面*/
        #editAddressPanel {
            width: 100vw;
            height: 100vh;
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            background: rgba(0,0,0,.7);
            z-index: 999;
        }
        #editAddressPanel>p {
            width: 100vw;
            height: 50vh;
            /*background: rgba(0,0,0,.5);*/
        }
        #editAddressPanel>div {
            width: 100vw;
            height: 50vh;
            position: relative;
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-pack: center;
                -ms-flex-pack: center;
                    justify-content: center;
            -webkit-box-align: stretch;
                -ms-flex-align: stretch;
                    align-items: stretch;
            -webkit-box-orient: vertical;
            -webkit-box-direction: normal;
                -ms-flex-flow: column;
                    flex-flow: column;
            margin-top: 50vh;
            background: #fff;
        }
        /*关闭按钮*/
        .closePannel {
            width: 8vw;
            height: 8vw;
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-pack: center;
                -ms-flex-pack: center;
                    justify-content: center;
            -webkit-box-align: center;
                -ms-flex-align: center;
                    align-items: center;
            position: absolute;
            top: 8px;
            left: 6px;
            padding: 3%;
            border-radius: 8vw;
            border: 1px solid #aaa;
        }
        /*填写姓名，电话等的区域*/
        #editAddressPanel>div>div {
            width: 70%;
            position: relative;
            left: 50%;
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-pack: justify;
                -ms-flex-pack: justify;
                    justify-content: space-between;
            -webkit-box-align: center;
                -ms-flex-align: center;
                    align-items: center;
            margin: 2vh 0 2vh -35%;
        }

        #editAddressPanel>div>div>label {
            -ms-flex-item-align: start;
                align-self: flex-start;
        }
        /*编辑的姓名，电话，地址*/
        .editName, .editPhone, .editAddress {
            margin: 0 1vw;
            padding: 1% 2%;
            border: 1px solid #aaa;
            border-radius: 4px;
        }
        .editAddress {
            width: 80%;
        }
        .saveAddress {
            width: 70%;
            position: relative;
            padding: 1vh 0;
            left: 50%;
            margin: 5% 5% 5% -35%;
            text-align: center;
            color: #fff;
            border-radius: 4px;
            background: #2EB6AA;
        }
        #areaDiv {
        	width: 80%;
        }
        #areaDiv>select {
        	width: 80%;
        	display: block;
        	margin: 10px 0;
        }
		#footer {
			width: 100vw;
			display: flex;
			align-items: center;
			position: fixed;
			padding: 3% 0%;
			bottom: 0;
			border-top: 1px solid #ddd;
		    background: #fff;
		}
		#footer>a {
			width: 100%;
			display: block;
		}
		#footer>a>input {
			width: 6vmin;
			height: 6vmin;
			margin: 0 20px;
			border-radius: 4px;
		    border: none;
		    color: #fff;
		    line-height: 6vmin;
		    vertical-align: middle;
		    font-size: 1.6rem;
		    background: #2EB6AA;
		}
	</style>
</head>
<body>
	<div id="content">
	<empty name="data">
		<h3 class="noaddress">还没有一条地址</h3>
	<else />
		<volist name="data" id="v">
			<div class="address" index="{{$v.id}}">
				<div class="aTop">
					<p>
						<span class="uName">{{$v.name}}</span>
						<span class="uPhone">{{$v.phone}}</span>
					</p>
					<input type="hidden" class="province" value="{{$v.province}}">
					<input type="hidden" class="city" value="{{$v.city}}">
					<input type="hidden" class="area" value="{{$v.area}}">
					<input type="hidden" class="town" value="{{$v.town}}">
					<p class="uAddress">{{$v.address}}</p>
				</div>
				<div class="aBottom">
					<div>
						<switch name="v.status">
							<case value="0">
								<input id="setAddress-{{$v.id}}" class="setAddress" type="radio" name="radio" index="{{$v.id}}" checked />
								<label for="setAddress-{{$v.id}}" index='{{$v.id}}'>默认地址</label>
								<p>
									<span class="edit" index="{{$v.id}}">编辑</span>
									<span class="del">删除</span>
								</p>
							</case>
							<case value="1">
								<input id="setAddress-{{$v.id}}" class="setAddress" type="radio" name="radio" index="{{$v.id}}" />
								<label for="setAddress-{{$v.id}}" index='{{$v.id}}'>默认地址</label>
								<p>
									<span class="edit" index="{{$v.id}}">编辑</span>
									<span class="del">删除</span>
								</p>
							</case>
						</switch>
					</div>
				</div>
			</div>
		</volist>
	</empty>
		<!-- <div class="address">
			<div class="aTop">
				<p>
					<span class="uName">Yoofds</span>
					<span class="uPhone">13612345678</span>
				</p>
				<p class="uAddress">广州市番禺区反倒是街道五巷7号</p>
			</div>
			<div class="aBottom">
				<div>
					<input id="setAddress-1" class="setAddress" type="radio" name="radio" index="1" />
					<label for="setAddress-1" index='1'>默认地址</label>
					<p>
						<span class="edit" index="1">编辑</span>
						<span class="del">删除</span>
					</p>
				</div>
			</div>
		</div> -->
	</div>
	<!-- 添加地址弹出面板 -->
	<div id="editAddressPanel">
		<p index="这个空标签不能删"></p>
		<div>
			<p class="closePannel">X</p>
			<div>
				<label for="">姓名:</label>
				<input type="text" placeholder="请输入姓名" autofocus class="editName" value='+ name +'>
			</div>
			<div>
				<label for="">电话:</label>
				<input type="text" placeholder="请输入电话" class="editPhone" value='+ phone +'>
			</div>
			<div id="areaChoose" class="citys">
				<div class="areaChoosebg"></div>
		        <div id="areaDiv">
					<select name="province">
	                	<option value="440000" data-code="440000">'+ province +'</option>
	                </select>
	                <select name="city">
	                	<option value="440100" data-code="440100">'+ city +'</option>
	                </select>
	                <select name="area">
	                	<option value="440103" data-code="440103">'+ area +'</option>
	                </select>
		            <select name="town">
		            	<option value="440113015">'+ town +'</option>
		            </select>
		    	</div>
			</div>
			<span class="saveAddress">保存</span>
		</div>
	</div>
	<footer id="footer">
		<a href="{{:U('Home/Address/newAddress')}}">
			<input type="button" id="newAddress" value="+">
			<label for="newAddress">添加新地址</label>
		</a>
	</footer>
	<script type="text/javascript" src="__PUBLIC__/Admin/layui/layui.js"></script>
	<script src="__PUBLIC__/Admin/js/plugins/layer/layer.min.js"></script>
    <script type="text/javascript" src="__PUBLIC__/Home/js/jquery.citys.js"></script>
	<script>
    $(function(){
        // 存放打开的地址的序号
        var addressIndex;

		// 存放姓名，电话，地址
		var uName, uPhone, uAddress, uProvicne, uCity, uArea, uTown, uAddress;

		/*
			点击文字默认地址
		 */
		$("#content").on('click','.normalAddress',function(){
			$(".normalAddress").each(function(index,key){
				$(".normalAddress").eq(index).siblings(".setAddress").attr("checked", false);
				// console.log(index, key);
			})
			$(this).siblings(".setAddress").attr("checked", true);
			console.log($(this).siblings(".setAddress"));
			uName = $(this).parents(".address").find(".uName").text();
			uPhone = $(this).parents(".address").find(".uPhone").text();
			uAddress = $(this).parents(".address").find(".uAddress").text();

			console.log('姓名：'+uName, '\n电话：'+uPhone, '\n地址：'+uAddress);
			var address_id = parseInt($(this).attr("index"));		//地址id
			// 发送ajax请求告诉后台，哪个是默认地址
			$.ajax({
				url: '{{:U("Address/edit_address")}}',
				type: 'post',
				data: {'address_id': address_id,'status': 0},
				success: function(res){
					console.log('成功！ ', res)
					// 选择默认地址后，返回上一页
					location.href = '{{:U("PaymentSystem/payConfirm")}}';
				},
				error: function(res){
					console.log('失败！ ', res)
				}
			});
			console.log(address_id)
		})
        /*
        	点击按钮设置默认地址
         */
        $("#content").on('click','.setAddress',function(){
            $(".normalAddress").each(function(index,key){
                $(".setAddress").eq(index).attr("checked", false);
                // console.log(index, key);
            })
            $(this).attr("checked", true);
            // console.log($(this).siblings(".setAddress"));
            uName = $(this).parents(".address").find(".uName").text();
            uPhone = $(this).parents(".address").find(".uPhone").text();
            uAddress = $(this).parents(".address").find(".uAddress").text();

            console.log('姓名：'+uName, '\n电话：'+uPhone, '\n地址：'+uAddress);
			
			var address_id = parseInt($(this).attr("index"));		//地址id
			// 发送ajax请求告诉后台，哪个是默认地址
			// console.log('address_id: ',address_id);
			$.ajax({
				url: '{{:U("Address/edit_address")}}',
				type: 'post',
				data: {'id': address_id,'status': 0},
				success: function(res){
					console.log('成功！ ', res)
					if(res.code == 200){
            			layHint('设置成功！');
            			setTimeout(function(){
            				// 默认地址设置成功，返回上一页
							location.href = '{{:U("PaymentSystem/payConfirm")}}'; 
            			},500);
							
					}else{
            			layHint('设置失败,请稍后再试！');
					}
				},
				error: function(res){
					console.log('失败！ ', res)
            		layHint('遇到未知问题，设置失败！');
				}
			});
        })

		// 点击‘X’关闭添加地址面板
		$("#editAddressPanel").on("click",".closePannel", function(){
            
			$("#editAddressPanel>div").animate({marginTop: '50vh'});
			var int = setInterval(function(){
				parseInt($("#editAddressPanel>div").css("marginTop")) >= $(window).height()/2-20
				? (
					$("#editAddressPanel").hide(),
					clearInterval(int)
				)
				: ''
			},100);
		})
		/*
			点击‘保存’关闭编辑地址面板
		 */
		$("#editAddressPanel").on("click",".saveAddress",function(){
            
			$("#editAddressPanel>div").animate({marginTop: '50vh'});
            editPanel()
			var int = setInterval(function(){
				parseInt($("#editAddressPanel>div").css("marginTop")) >= $(window).height()/2-20
				? (
					$("#editAddressPanel").hide(),
					clearInterval(int)
				)
				: ''
			},100);
            // 获取当前面板的姓名，电话，地址
            var editName = $(this).parents("#editAddressPanel").find(".editName").val();
            var editPhone = $(this).parents("#editAddressPanel").find(".editPhone").val();
            var editProvince = $(this).parents("#editAddressPanel").find(".editProvince").val();
            var editCity = $(this).parents("#editAddressPanel").find(".editCity").val();
            var editArea = $(this).parents("#editAddressPanel").find(".editArea").val();
            var editTown = $(this).parents("#editAddressPanel").find(".editTown").val();
            var editAddress = $(this).parents("#editAddressPanel").find(".editAddress").val();

            console.log(editName, editPhone, editAddress)
            // 显示编辑面板
            $("#editAddressPanel").show();
            $("#editAddressPanel>div").animate({marginTop: '0'});
            // $("#editAddressPanel>div").html(editPanel(editName, editPhone, editAddress))

            //addressIndex：判断打开的是哪个地址, 点击'编辑'的时候获取
            console.log(addressIndex, $(".address").eq(addressIndex))
            var editAddressObj = {};	//编辑地址需要发到后台的数据
            if(editName == uName){
	    		editAddressObj['name'] = editName;

            }else if(editPhone == uPhone){
	    		editAddressObj['phone'] = editPhone;

            }else if(editProvince == uProvince){
            	editAddressObj['province'] = editProvince;

            }else if(editCity == uCity){
            	editAddressObj['city'] = editCity;

            }else if(editArea == uArea){
            	editAddressObj['area'] = editArea;

            }else if(editTown == uTown){
            	editAddressObj['town'] = editTown;

            }
	    	editAddressObj['addressDetial'] = editAddress;
	    	console.log(editAddressObj);
            // 发送ajax让后台修改这条地址在数据库的数据
            // $.ajax({
            // 	url: '{{:U("Home/Address/save_address")}}',
            // 	type: 'post',
            // 	data: editAddressObj,
            // 	success: function(res){
            // 		console.log('成功！', res)
            // 		//后台返回参数确认修改成功
            // 		if(res == 200){
            // 			layHint('保存成功！');
			         //    // 将修改更新到页面相应位置
			         //    if(editName && editPhone && editAddress){
			         //        // 点击编辑进来的
			         //        $("#content").find(".address").eq(addressIndex).find(".uName").text(editName)
			         //        $("#content").find(".address").eq(addressIndex).find(".uPhone").text(editPhone)
			         //        $("#content").find(".address").eq(addressIndex).find(".uAddress").text(editAddress)
			         //        console.log($("#content").find(".address").eq(addressIndex))
			         //    }
            // 		}else{
            // 			layHint('保存失败！');
            // 		}
            // 	},
            // 	error: function(res){
            // 		console.log('失败！', res)
            // 		layHint('保存失败！');
            // 	}
            // })
			
		})

		// 编辑面板字符串模板函数
		function editPanel(name,phone,province,city,area,town,address){
			name = name || ''; 
			phone = phone || ''; 
			province = province || '';
			city = city || '';
			area = area || '';
			town = town || '';
			address = address || '';
			
			// 生成编辑内容
			return '<p class="closePannel">X</p>'+
				'<div>'+
					'<label for="">姓名:</label>'+
					'<input type="text" placeholder="请输入姓名" autofocus class="editName" value='+ name +'>'+
				'</div>'+
				'<div>'+
					'<label for="">电话:</label>'+
					'<input type="text" placeholder="请输入电话" class="editPhone" value='+ phone +'>'+
				'</div>'+
				'<div id="areaChoose" class="citys">'+
					'<div class="areaChoosebg"></div>'+
			        '<div class="areaDiv">'+
						'<p>'+
							'<select name="province">'+
			                	'<option value="440000" data-code="440000">'+ province +'</option>'+
			                '</select>'+
			                '<select name="city">'+
			                	'<option value="440100" data-code="440100">'+ city +'</option>'+
			                '</select>'+
			                '<select name="area">'+
			                	'<option value="440103" data-code="440103">'+ area +'</option>'+
			                '</select>'+
				            '<select name="town">'+
				            	'<option value="440113015">'+ town +'</option>'+
				            '</select>'+
						'</p>'+
			    	'</div>'+
				'</div>'+
				'<span class="saveAddress">保存</span>';
		}
        // 新建地址保存生成HTML字符串模板函数
        // function addressHTML(editName, editPhone, editAddress){ 

        //     return '<div class="address">'+
        //         '<div class="aTop">'+
        //             '<p>'+
        //                 '<span class="uName">'+ editName +'</span>'+
        //                 '<span class="uPhone">'+ editPhone +'</span>'+
        //             '</p>'+
        //             '<p class="uAddress">'+ editAddress +'</p>'+
        //         '</div>'+
        //         '<div class="aBottom">'+
        //             '<div>'+
        //                 '<input class="setAddress" type="checkbox" />'+
        //                 '<span class="normalAddress">默认地址</span>'+
        //                 '<p>'+
        //                     '<span class="edit" addressIndex="'+ $(".address").length +'">编辑</span>'+
        //                     '<span class="del">删除</span>'+
        //                 '</p>'+
        //             '</div>'+
        //         '</div>'+
        //     '</div>';
        // }
		/*
			点击编辑按钮
		 */ 
		$("#content").on("click",'.edit',function(){
			
            //判断打开的是哪个地址
            addressIndex = parseInt($(this).attr("index"));
            // 将编辑所在条目的姓名，电话，地址填写到面板相应位置
			uName = $(this).parents(".address").find(".uName").text();
			uPhone = $(this).parents(".address").find(".uPhone").text();
			uProvince = $(this).parents(".address").find(".province").val();
			uCity = $(this).parents(".address").find(".city").val();
			uArea = $(this).parents(".address").find(".area").val();
			uTown = $(this).parents(".address").find(".town").val();
			uAddress = $(this).parents(".address").find(".uAddress").text();
			console.log(uName, uPhone,uProvince,uCity,uArea, uTown,uAddress);
            // 显示编辑面板
            $("#editAddressPanel").show();
            $("#editAddressPanel>div").animate({marginTop: '0'});
			// $("#editAddressPanel>div").html(editPanel(uName,uPhone,uProvince,uCity,uArea,uTown,uAddress))
		})

        /*
        	点击删除按钮
         */
        $("#content").on('click','.del',function(){
        	var _this = $(this);
        	var address_id = $(this).siblings(".edit").attr("index");
            console.log('address_id: ',address_id);
			layer.confirm('确认删除？删除后无法恢复！', 
	            {
	              btn: ['确定','取消'] //按钮
	            }, 
	            function(){
		            // 发送ajax让后台删除这条地址在数据库的数据
		            $.ajax({
		            	url: '{{:U("Address/del_address")}}',
		            	type: 'post',
		            	data: {'id': address_id},
		            	success: function(res){
		            		console.log('成功！', res)
		            		//后台返回参数确认删除成功
		            		if(res.code == 200){
		            			_this.parents(".address").remove();
		            			layHint('删除成功！');
		            		}else{
		            			layHint('删除失败！');
		            		}
		            	},
		            	error: function(res){
		            		console.log('失败！', res)
		            		layHint('删除失败！');
		            	}
		            })
		            return true;
	            },
	            function(){
	                layer.msg('已取消！', {icon: 1});
	                return false;
	            }
	        );
        })

        // 将数据输出为JSON对象数组格式
        var arr = [];
        for(var i=0; i<$(".address").length; i++){
            arr.push({
                uName: $(".address").eq(i).find(".uName").text(),
                uPhone: $(".address").eq(i).find(".uPhone").text(),
                uAddress: $(".address").eq(i).find(".uAddress").text()
            })
        }
        console.log(arr);

	    //提示框函数
	    function layHint(text){
    		layui.use('layer', function(){
                var layer = layui.layer;
                layer.msg(text);
            });
	    }
		/*
			地址四级联动
		 */
		var script = $("<script/>");
		var scriptCode = `
			var province,city,area,town;

			// 关闭地区选择，并显示到对应区域
			$("#confirmAreaChoose").on("click", function(){
				
				$("#areaID").val( (!city && !area) ? '请选择' : city + area);

				// 获取 街道 选中的值
				$("#townID")
				.val(
					!($('#areaChoose select[name="town"]').find("option:selected").text())
					? '请选择'
					: $('#areaChoose select[name="town"]').find("option:selected").text()
				);

				$("#areaChoose").css({display: "none"});
				// console.log($('#areaChoose select[name="town"]').find("option:selected"));

			});

			// 生成选择地区~省市县街道四级联动
			var $town = $('#areaChoose').find('select[name="town"]');
		    var townFormat = function(info){
			    $town.hide().empty();
			    if(info['code']%1e4&&info['code']<7e6){	//是否为“区”且不是港澳台地区
			    	$.ajax({
			    		url:'http://passer-by.com/data_location/town/'+info['code']+'.json',
			    		dataType:'json',
			    		success:function(town){
			    			$town.show();
		    				// console.log(town);
		    				var townHTML = '';
			    			for(i in town){
			    				townHTML += '<option value="'+i+'">'+town[i]+'</option>';
			    			};
			    			$town.append(townHTML);
			    			// console.log($town)

					    	province = info.province;	//省、市、区在这里生成
							city = info.city;
							area = info.area;
			    		},
			    		err: function(res){
			    			console.log(res);
			    		}
			    	});
			    }
		    };
		    $('#areaChoose').citys({
		    	required: false,
		    	nodata: 'disabled',
		        onChange:function(info){
		        	townFormat(info);
		        }
		    },function(api){
		        var info = api.getInfo();
		        townFormat(info);
		    });`
		script.html(scriptCode);
		$("body").append(script);
       
    })
	</script>
</body>
</html>