<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
	<link rel="stylesheet" href="__PUBLIC__/Home/css/resetstyle.css">
	<script src="__PUBLIC__/Home/js/public.js"></script>
	<script src="__PUBLIC__/Home/js/jquery-1.8.3.min.js"></script>
    <script type="text/javascript" src="__PUBLIC__/Home/js/jquery.citys.js"></script>
	<title>添加新地址</title>
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}
		body {
			width: 100vw;
		    height: 100vh;
		    left: 0;
		    top: 0;
		    background: #eee;
			font-size: .7rem;
			overflow-x: hidden;
		}
		/*个人信息*/
		#info {
			width: 100vw;
			background: #fff;
		}
		#info>div {
			width: 100%;
			display: flex;
			padding: 3% 5%;
			white-space: nowrap;    
			border-bottom: 1px solid #eee;
		}
		#info>div>span {
			width: 20vw;
		}
		#info>div>input {
			width: 80%;
			padding: 1%;
			border: none;
			outline: none;
		}
		#info>div>input:focus {
			background: #f6f6f6;
		}
		#info>div>span:nth-of-type(2) {
			width: 80%;
			display: flex;
			justify-content: flex-end;
			align-items: center;
		}
		#info>div>span:nth-of-type(2)>input:nth-of-type(2) {
			width: 6%;
			padding: 1%;
			margin: 0 6px;
			border: none;
			outline: none;
			background: #fff;
		}
		#info>div>span:nth-of-type(2)>label {
			color: #8b8787;
		}
		.area, .town {   
			width: 96%;
			margin-left: 10px;
			border: none;
			background: #fff;
			text-align: right;
		}
		/*地区选择*/
		#areaChoose {
			width: 100vw;
			height: 100vh;
			display: none;
			position: fixed;
			top: 0;
			left: 0;
			flex-flow: column;
			padding: 0;
			border-bottom: none;
			z-index: 1000;
		}
		.areaChoosebg {
			width: 100vw;
			height: 50vh;
			background: rgba(0,0,0, .4);
		}
		.areaDiv {
			height: 36vh;
			display: flex;
			justify-content: center;
			align-items: center;
			background: #fff;
		}
		/*弹出地区选择底部的确认按钮*/
		#confirmAreaChoose {
			height: 14vh;
			display: flex;
			justify-content: center;
			align-items: center;
			background: #fff;
		}
		#confirmAreaChoose>div {
			width: 80%;
    		padding: 2%;
    		text-align: center;
			color: #fff;
			border-radius: 4px;
			background: #2EB6AA;
		}
		.areaDiv>p {
			width: 80%;
			display: flex;
			flex-flow: column;
		}
		.areaDiv>p>select {
			width: 80%;
			padding: 1% 2%;
			margin: 10px auto;
			border-radius: 4px;
    		background: #fff;
		}
		/*详细地址*/
		textarea {
			width: 100vw;
			padding: 2% 5%;
			border: none;
		}

		/*设为默认地址开关一栏*/
		#norAddrDiv {
			width: 100vw;
			display: flex;
			align-items: center;
			justify-content: space-between;
			padding: 3% 5%;
		}

		/*设为默认地址开关*/
		#normalAddrdess {
			width: 10vmin;
			height: 6vmin;
			display: flex;
			align-items: center;
			position: relative;
			float: right;
			outline: none;
			-webkit-appearance: none;
			border-radius: 20px;
			border: 1px solid #cacaca;
			background: #c7c7c7;
		}
		/*设为默认地址开关的白点*/
		#normalAddrdess:before {
			content: '';
			width: 5vmin;
			height: 5vmin;
			position: relative;
			top: 0;
			left: 0;
    		margin-left: .17vmin;
			border-radius: 20px;
			background: #fff;
			transition: left .2s ease-in;
		}

		#normalAddrdess:after {
			content: '';
			clear: both;
		}
		/*设为默认地址开关的开启状态*/
		#normalAddrdess:checked{
			border: none;
			outline: none;
			background: #2EB6AA;
		}
		#normalAddrdess:checked::before {
			content: '';
			left: 42%;
		}
		#footer {
			width: 100vw;
			display: flex;
			justify-content: center;
			align-items: center;
			position: fixed;
			padding: 3% 0%;
			bottom: 8vmin;
		}
		#footer>input {
			width: 80vmin;
			padding: 2% 0;
			border-radius: 4px;
		    border: none;
		    color: #fff;
		    line-height: 6vmin;
		    vertical-align: middle;
		    font-size: .8rem;
		    background: #2EB6AA;
		}
	</style>
</head>
<body>
	<div id="info">
		<div>
			<span>收&nbsp;&nbsp;货&nbsp;人:</span>
			<input type="text" class="name" placeholder="收货人">
		</div>
		<div>
			<span>联系电话:</span>
			<input type="text" class="phone" placeholder="电话">
		</div>
		<div>
			<span>所在地区:</span>
			<span>
				<input type="button" id="areaID" class="area" value="请选择">
				<input type="button" readonly value=">">
			</span>
			
		</div>
		<div>
			<span>街&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;道:</span>
			<span>
				<input type="button" id="townID" class="town" placeholder="请输入街道">
			</span>
			
		</div>
		<textarea name="" id="addressDetial" cols="30" rows="10" placeholder="请谨慎填写详细地址"></textarea>
	</div>
	<div id="areaChoose" class="citys">
		<div class="areaChoosebg"></div>
        <div class="areaDiv">
			<p>
				<select name="province">
                	<option value="440000" data-code="440000">广东省</option>
                </select>
                <select name="city">
                	<option value="440100" data-code="440100">广州市</option>
                </select>
                <select name="area">
                	<option value="440103" data-code="440103">番禺区</option>
                </select>
	            <select name="town">
	            	<option value="440113015">钟村街道</option>
	            </select>
			</p>
    	</div>
    	<div id="confirmAreaChoose">
    		<div>确定</div>
    	</div>
	</div>
	<div id="norAddrDiv">
		<label for="normalAddrdess">
			设为默认地址
		</label>
		<input id="normalAddrdess" type="checkbox">
	</div>
	<footer id="footer">
		<input type="button" id="saveAddress" value="存储">
	</footer>
	<script type="text/javascript" src="__PUBLIC__/Admin/layui/layui.js"></script>
	<script>
		var lvxinData = sessionStorage.getItem("lvxinData"),
			shopCar_data = sessionStorage.getItem("shopCar_data"),
			goods_data = sessionStorage.getItem("goods_data");
		// 解决移动端虚拟键盘开启时底部内容被顶上来的问题
		solveCompatible($("#footer"));
		var script = $("<script/>");
		var scriptCode = `
			// 选择地区
			$(".area").on("click", function(){
				$("#areaChoose").css({display: "block"});
			});

			var province,city,area,town;

			// 关闭地区选择，并显示到对应区域
			$("#confirmAreaChoose").on("click", function(){
				
				$("#areaID").val( (!city && !area) ? '请选择' : city + area);

				// 获取 街道 选中的值
				$("#townID")
				.val(
					!($('#areaChoose select[name="town"]').find("option:selected").text())
					? '请选择'
					: $('#areaChoose select[name="town"]').find("option:selected").text()
				);

				$("#areaChoose").css({display: "none"});
				// console.log($('#areaChoose select[name="town"]').find("option:selected"));

			});

			// 生成选择地区~省市县街道四级联动
			var $town = $('#areaChoose').find('select[name="town"]');
		    var townFormat = function(info){
			    $town.hide().empty();
			    if(info['code']%1e4&&info['code']<7e6){	//是否为“区”且不是港澳台地区
			    	$.ajax({
			    		url:'http://passer-by.com/data_location/town/'+info['code']+'.json',
			    		dataType:'json',
			    		success:function(town){
			    			$town.show();
		    				// console.log(town);
		    				var townHTML = '';
			    			for(i in town){
			    				townHTML += '<option value="'+i+'">'+town[i]+'</option>';
			    			};
			    			$town.append(townHTML);
			    			// console.log($town)

					    	province = info.province;	//省、市、区在这里生成
							city = info.city;
							area = info.area;
			    		},
			    		err: function(res){
			    			console.log(res);
			    		}
			    	});
			    }
		    };
		    $('#areaChoose').citys({
		    	required: false,
		    	nodata: 'disabled',
		        onChange:function(info){
		        	townFormat(info);
		        }
		    },function(api){
		        var info = api.getInfo();
		        townFormat(info);
		    });`
		script.html(scriptCode);
		$("body").append(script);

	    /*
	    	name: 收货人
	    	phone: 电话
	    	areaID: 市县
	    	town: 街道
	     */
	    // 验证姓名，电话，地区的正则表达式
	    var nameReg, phoneReg, areaReg;
	    nameReg = /^[\w\-\u4e00-\u9fa5]{2,255}$/u;
	    phoneReg = /^1((((3[0-35-9])|([5|8][0-9])|(4[5|7|9])|66|(7[3|5-8])|(9[8|9]))\d)|(34[0-8]))\d{7}$/;
	    areaReg = /^[\w\-\u4e00-\u9fa5]{2,255}$/u;

	    // 点击’存储‘
	    $("#saveAddress").click(function(){
	    	// 存储新建地址的个人信息
	    	var nameRes = nameReg.test($(".name").val());
	    	var phoneRes = phoneReg.test($(".phone").val());
	    	var areaIDRes = nameReg.test($("#areaID").val());
	    	var townRes = nameReg.test($(".town").val());
	    	var addressDetialRes = nameReg.test($("#addressDetial").val());

		    // console.log($("#normalAddrdess")[0].checked)
	    	var newAddressObj = {};
	    	if(nameRes && phoneRes && areaIDRes && townRes && addressDetialRes && $(".town").val() != '请选择'){
	    		console.log('通过！')

		    	newAddressObj['name'] = $(".name").val();
		    	newAddressObj['phone'] = $(".phone").val();
		    	newAddressObj['province'] = province;
		    	newAddressObj['city'] = city;
		    	newAddressObj['area'] = area;
		    	newAddressObj['town'] = $("#townID").val();
		    	if($("#normalAddrdess").attr("checked")){
		    		//设为默认地址
		    		newAddressObj['status'] = 0;
		    	}else{
		    		newAddressObj['status'] = 1;
		    	}
		    	console.log(newAddressObj);
		    	// 全部判断通过则发送请求让后台添加到数据库
		    	$.ajax({
		    		url: "{{:U('Address/newAddress')}}",
		    		type: 'post',
		    		data: newAddressObj,
		    		success: function(res){
		    			console.log('成功！ ', res);
		    			layHint('添加成功！');
		    			//自动跳回去订单提交那里
		    			if(goods_data || lvxinData || shopCar_data){
		    				location.href = "{{:U('PaymentSystem/payConfirm')}}"
		    			}
		    		},
		    		error: function(res){
		    			console.log('失败！ ', res);
		    		}
		    	})

	    	}else if(!nameRes){
	    		// 验证姓名
	    		console.log('请输入符合规范的姓名！');
	    		layHint('请输入合法的姓名！')

	    	}else if(!phoneRes){
	    		console.log('请输入正确的电话号码！');
	    		layHint('请输入正确的电话号码！')

	    	}else if(!areaIDRes){
	    		console.log('请选择地区！');
	    		layHint('请选择地区！')
	    		
	    	}else if(!townRes || !$(".town").val()){
	    		console.log('请输入街道！');
	    		layHint('请选择街道！')
	    		
	    	}else if(!addressDetialRes){
	    		console.log('请输入详细地址！');
	    		layHint('请输入详细地址！')
	    		
	    	}
	    })

	    function layHint(text){
    		layui.use('layer', function(){
                var layer = layui.layer;
                layer.msg(text);
            });
	    }

	</script>
</body>
</html>